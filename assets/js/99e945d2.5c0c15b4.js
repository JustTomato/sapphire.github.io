"use strict";(self.webpackChunksapphire=self.webpackChunksapphire||[]).push([[992],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>h});var a=t(7294);function l(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){l(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,a,l=function(e,n){if(null==e)return{};var t,a,l={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(l[t]=e[t]);return l}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(l[t]=e[t])}return l}var d=a.createContext({}),s=function(e){var n=a.useContext(d),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},p=function(e){var n=s(e.components);return a.createElement(d.Provider,{value:n},e.children)},c="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,l=e.mdxType,r=e.originalType,d=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),c=s(t),m=l,h=c["".concat(d,".").concat(m)]||c[m]||u[m]||r;return t?a.createElement(h,o(o({ref:n},p),{},{components:t})):a.createElement(h,o({ref:n},p))}));function h(e,n){var t=arguments,l=n&&n.mdxType;if("string"==typeof e||l){var r=t.length,o=new Array(r);o[0]=m;var i={};for(var d in n)hasOwnProperty.call(n,d)&&(i[d]=n[d]);i.originalType=e,i[c]="string"==typeof e?e:l,o[1]=i;for(var s=2;s<r;s++)o[s]=t[s];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},8821:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>i,toc:()=>s});var a=t(7462),l=(t(7294),t(3905));const r={},o="Vue2\u539f\u7406",i={unversionedId:"vue/Vue2",id:"vue/Vue2",title:"Vue2\u539f\u7406",description:"\u4e00\u3001\u54cd\u5e94\u5f0f\u539f\u7406",source:"@site/docs/vue/Vue2.md",sourceDirName:"vue",slug:"/vue/Vue2",permalink:"/sapphire.github.io/docs/vue/Vue2",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"\u8fdb\u9636Vue\u7bc7\uff08\u4e00\uff09",permalink:"/sapphire.github.io/docs/vue/Basic"},next:{title:"\u8def\u7531",permalink:"/sapphire.github.io/docs/vue/Vue-Router"}},d={},s=[{value:"\u4e00\u3001\u54cd\u5e94\u5f0f\u539f\u7406",id:"\u4e00\u54cd\u5e94\u5f0f\u539f\u7406",level:2},{value:"1.\u521d\u59cb\u5316\u6570\u636e",id:"1\u521d\u59cb\u5316\u6570\u636e",level:5},{value:"2.\u9012\u5f52\u5c5e\u6027\u52ab\u6301",id:"2\u9012\u5f52\u5c5e\u6027\u52ab\u6301",level:5},{value:"3.\u6570\u7ec4\u65b9\u6cd5\u7684\u52ab\u6301",id:"3\u6570\u7ec4\u65b9\u6cd5\u7684\u52ab\u6301",level:5},{value:"4.\u6570\u636e\u4ee3\u7406",id:"4\u6570\u636e\u4ee3\u7406",level:5},{value:"\u4e8c\u3001\u6a21\u677f\u7f16\u8bd1",id:"\u4e8c\u6a21\u677f\u7f16\u8bd1",level:2},{value:"1.\u89e3\u6790\u6807\u7b7e\u548c\u5185\u5bb9",id:"1\u89e3\u6790\u6807\u7b7e\u548c\u5185\u5bb9",level:5},{value:"2.\u751f\u6210<code>ast</code>\u8bed\u6cd5\u6811",id:"2\u751f\u6210ast\u8bed\u6cd5\u6811",level:5},{value:"3.\u751f\u6210\u4ee3\u7801",id:"3\u751f\u6210\u4ee3\u7801",level:5},{value:"4.\u751f\u6210<code>render</code>\u51fd\u6570",id:"4\u751f\u6210render\u51fd\u6570",level:5},{value:"\u4e09\u3001\u521b\u5efa\u6e32\u67d3<code>watcher</code>",id:"\u4e09\u521b\u5efa\u6e32\u67d3watcher",level:2},{value:"1.\u521d\u59cb\u5316\u6e32\u67d3Watcher",id:"1\u521d\u59cb\u5316\u6e32\u67d3watcher",level:5},{value:"2.\u751f\u6210\u865a\u62df<code>dom</code>",id:"2\u751f\u6210\u865a\u62dfdom",level:5},{value:"3.\u751f\u6210\u771f\u5b9e<code>DOM</code>\u5143\u7d20",id:"3\u751f\u6210\u771f\u5b9edom\u5143\u7d20",level:5},{value:"\u56db\u3001\u751f\u547d\u5468\u671f\u7684\u5408\u5e76",id:"\u56db\u751f\u547d\u5468\u671f\u7684\u5408\u5e76",level:2},{value:"1.Mixin\u539f\u7406",id:"1mixin\u539f\u7406",level:5},{value:"2.\u5408\u5e76\u751f\u547d\u5468\u671f",id:"2\u5408\u5e76\u751f\u547d\u5468\u671f",level:5},{value:"3.\u8c03\u7528\u751f\u547d\u5468\u671f",id:"3\u8c03\u7528\u751f\u547d\u5468\u671f",level:5},{value:"4.\u521d\u59cb\u5316\u6d41\u7a0b\u4e2d\u8c03\u7528\u751f\u547d\u5468\u671f",id:"4\u521d\u59cb\u5316\u6d41\u7a0b\u4e2d\u8c03\u7528\u751f\u547d\u5468\u671f",level:5},{value:"\u4e94\u3001\u4f9d\u8d56\u6536\u96c6",id:"\u4e94\u4f9d\u8d56\u6536\u96c6",level:2},{value:"1.\u5728\u6e32\u67d3\u65f6\u5b58\u50a8watcher",id:"1\u5728\u6e32\u67d3\u65f6\u5b58\u50a8watcher",level:5},{value:"2.\u5bf9\u8c61\u4f9d\u8d56\u6536\u96c6",id:"2\u5bf9\u8c61\u4f9d\u8d56\u6536\u96c6",level:5},{value:"3.\u6570\u7ec4\u7684\u4f9d\u8d56\u6536\u96c6",id:"3\u6570\u7ec4\u7684\u4f9d\u8d56\u6536\u96c6",level:5},{value:"\u516d.\u5b9e\u73b0Vue\u5f02\u6b65\u66f4\u65b0\u4e4b<code>nextTick</code>",id:"\u516d\u5b9e\u73b0vue\u5f02\u6b65\u66f4\u65b0\u4e4bnexttick",level:2},{value:"1.\u5b9e\u73b0\u961f\u5217\u673a\u5236",id:"1\u5b9e\u73b0\u961f\u5217\u673a\u5236",level:5},{value:"2.nextTick\u5b9e\u73b0\u539f\u7406",id:"2nexttick\u5b9e\u73b0\u539f\u7406",level:5},{value:"\u4e03\u3001Watch &amp; Computed",id:"\u4e03watch--computed",level:2},{value:"1.Watch\u5b9e\u73b0\u539f\u7406",id:"1watch\u5b9e\u73b0\u539f\u7406",level:5},{value:"2.Computed\u5b9e\u73b0\u539f\u7406",id:"2computed\u5b9e\u73b0\u539f\u7406",level:5},{value:"\u516b\u3001Vue\u7ec4\u4ef6\u539f\u7406\u89e3\u6790",id:"\u516bvue\u7ec4\u4ef6\u539f\u7406\u89e3\u6790",level:2},{value:"1.\u5168\u5c40\u7ec4\u4ef6\u7684\u89e3\u6790",id:"1\u5168\u5c40\u7ec4\u4ef6\u7684\u89e3\u6790",level:5},{value:"1.<code>Vue.component</code>\u65b9\u6cd5",id:"1vuecomponent\u65b9\u6cd5",level:6},{value:"2.<code>Vue.extend</code>\u65b9\u6cd5",id:"2vueextend\u65b9\u6cd5",level:6},{value:"3.\u5c5e\u6027\u5408\u5e76",id:"3\u5c5e\u6027\u5408\u5e76",level:6},{value:"4.\u521d\u59cb\u5316\u5408\u5e76",id:"4\u521d\u59cb\u5316\u5408\u5e76",level:6},{value:"2.\u7ec4\u4ef6\u7684\u6e32\u67d3",id:"2\u7ec4\u4ef6\u7684\u6e32\u67d3",level:5},{value:"1.\u521b\u5efa\u7ec4\u4ef6\u865a\u62df\u8282\u70b9",id:"1\u521b\u5efa\u7ec4\u4ef6\u865a\u62df\u8282\u70b9",level:6},{value:"2.\u521b\u5efa\u7ec4\u4ef6\u7684\u771f\u5b9e\u8282\u70b9",id:"2\u521b\u5efa\u7ec4\u4ef6\u7684\u771f\u5b9e\u8282\u70b9",level:6},{value:"\u4e5d\u3001Vue\u4e2dDiff\u7b97\u6cd5\u89e3\u6790",id:"\u4e5dvue\u4e2ddiff\u7b97\u6cd5\u89e3\u6790",level:2},{value:"\u4e00.\u57fa\u672cDiff\u7b97\u6cd5",id:"\u4e00\u57fa\u672cdiff\u7b97\u6cd5",level:3},{value:"1.\u6bd4\u5bf9\u6807\u7b7e",id:"1\u6bd4\u5bf9\u6807\u7b7e",level:4},{value:"2.\u6bd4\u5bf9\u5c5e\u6027",id:"2\u6bd4\u5bf9\u5c5e\u6027",level:4},{value:"3.\u6bd4\u5bf9\u5b50\u5143\u7d20",id:"3\u6bd4\u5bf9\u5b50\u5143\u7d20",level:4},{value:"\u4e8c.Diff\u4e2d\u7684\u4f18\u5316\u7b56\u7565",id:"\u4e8cdiff\u4e2d\u7684\u4f18\u5316\u7b56\u7565",level:3},{value:"1.\u5728\u5f00\u5934\u548c\u7ed3\u5c3e\u65b0\u589e\u5143\u7d20",id:"1\u5728\u5f00\u5934\u548c\u7ed3\u5c3e\u65b0\u589e\u5143\u7d20",level:4},{value:"2.\u5934\u79fb\u5c3e\u3001\u5c3e\u79fb\u5934",id:"2\u5934\u79fb\u5c3e\u5c3e\u79fb\u5934",level:4},{value:"3.\u66b4\u529b\u6bd4\u5bf9",id:"3\u66b4\u529b\u6bd4\u5bf9",level:4},{value:"\u4e09.\u66f4\u65b0\u64cd\u4f5c",id:"\u4e09\u66f4\u65b0\u64cd\u4f5c",level:3}],p={toc:s},c="wrapper";function u(e){let{components:n,...r}=e;return(0,l.kt)(c,(0,a.Z)({},p,r,{components:n,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"vue2\u539f\u7406"},"Vue2\u539f\u7406"),(0,l.kt)("h2",{id:"\u4e00\u54cd\u5e94\u5f0f\u539f\u7406"},"\u4e00\u3001\u54cd\u5e94\u5f0f\u539f\u7406"),(0,l.kt)("p",null,"\u5bfc\u51fa",(0,l.kt)("inlineCode",{parentName:"p"},"vue"),"\u6784\u9020\u51fd\u6570"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"import {initMixin} from './init';\n\nfunction Vue(options) {\n    this._init(options);\n}\ninitMixin(Vue); // \u7ed9\u539f\u578b\u4e0a\u65b0\u589e_init\u65b9\u6cd5\nexport default Vue;\n")),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"init"),"\u65b9\u6cd5\u4e2d\u521d\u59cb\u5316",(0,l.kt)("inlineCode",{parentName:"p"},"vue"),"\u72b6\u6001"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"import {initState} from './state';\nexport function initMixin(Vue){\n    Vue.prototype._init = function (options) {\n        const vm  = this;\n        vm.$options = options\n        // \u521d\u59cb\u5316\u72b6\u6001\n        initState(vm)\n    }\n}\n")),(0,l.kt)("p",null,"\u6839\u636e\u4e0d\u540c\u5c5e\u6027\u8fdb\u884c\u521d\u59cb\u5316\u64cd\u4f5c"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"export function initState(vm){\n    const opts = vm.$options;\n    if(opts.props){\n        initProps(vm);\n    }\n    if(opts.methods){\n        initMethod(vm);\n    }\n    if(opts.data){\n        // \u521d\u59cb\u5316data\n        initData(vm);\n    }\n    if(opts.computed){\n        initComputed(vm);\n    }\n    if(opts.watch){\n        initWatch(vm);\n    }\n}\nfunction initProps(){}\nfunction initMethod(){}\nfunction initData(){}\nfunction initComputed(){}\nfunction initWatch(){}\n")),(0,l.kt)("h5",{id:"1\u521d\u59cb\u5316\u6570\u636e"},"1.\u521d\u59cb\u5316\u6570\u636e"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"import {observe} from './observer/index.js'\nfunction initData(vm){\n    let data = vm.$options.data;\n    data = vm._data = typeof data === 'function' ? data.call(vm) : data;\n    observe(data);\n}\n")),(0,l.kt)("h5",{id:"2\u9012\u5f52\u5c5e\u6027\u52ab\u6301"},"2.\u9012\u5f52\u5c5e\u6027\u52ab\u6301"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"class Observer { // \u89c2\u6d4b\u503c\n    constructor(value){\n        this.walk(value);\n    }\n    walk(data){ // \u8ba9\u5bf9\u8c61\u4e0a\u7684\u6240\u6709\u5c5e\u6027\u4f9d\u6b21\u8fdb\u884c\u89c2\u6d4b\n        let keys = Object.keys(data);\n        for(let i = 0; i < keys.length; i++){\n            let key = keys[i];\n            let value = data[key];\n            defineReactive(data,key,value);\n        }\n    }\n}\nfunction defineReactive(data,key,value){\n    observe(value);\n    Object.defineProperty(data,key,{\n        get(){\n            return value\n        },\n        set(newValue){\n            if(newValue == value) return;\n            observe(newValue);\n            value = newValue\n        }\n    })\n}\nexport function observe(data) {\n    if(typeof data !== 'object' || data == null){\n        return;\n    }\n    return new Observer(data);\n}\n")),(0,l.kt)("h5",{id:"3\u6570\u7ec4\u65b9\u6cd5\u7684\u52ab\u6301"},"3.\u6570\u7ec4\u65b9\u6cd5\u7684\u52ab\u6301"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"import {arrayMethods} from './array';\nclass Observer { // \u89c2\u6d4b\u503c\n    constructor(value){\n        if(Array.isArray(value)){\n            value.__proto__ = arrayMethods; // \u91cd\u5199\u6570\u7ec4\u539f\u578b\u65b9\u6cd5\n            this.observeArray(value);\n        }else{\n            this.walk(value);\n        }\n    }\n    observeArray(value){\n        for(let i = 0 ; i < value.length ;i ++){\n            observe(value[i]);\n        }\n    }\n}\n")),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"\u91cd\u5199\u6570\u7ec4\u539f\u578b\u65b9\u6cd5")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"let oldArrayProtoMethods = Array.prototype;\nexport let arrayMethods = Object.create(oldArrayProtoMethods);\nlet methods = [\n    'push',\n    'pop',\n    'shift',\n    'unshift',\n    'reverse',\n    'sort',\n    'splice'\n];\nmethods.forEach(method => {\n    arrayMethods[method] = function (...args) {\n        const result = oldArrayProtoMethods[method].apply(this, args);\n        const ob = this.__ob__;\n        let inserted;\n        switch (method) {\n            case 'push':\n            case 'unshift':\n                inserted = args;\n                break;\n            case 'splice':\n                inserted = args.slice(2)\n            default:\n                break;\n        }\n        if (inserted) ob.observeArray(inserted); // \u5bf9\u65b0\u589e\u7684\u6bcf\u4e00\u9879\u8fdb\u884c\u89c2\u6d4b\n        return result\n    }\n})\n")),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"\u589e\u52a0",(0,l.kt)("inlineCode",{parentName:"strong"},"__ob__"),"\u5c5e\u6027")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"class Observer { \n    constructor(value){\n        Object.defineProperty(value,'__ob__',{\n            enumerable:false,\n            configurable:false,\n            value:this\n        });\n        // ...\n    }\n }\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u7ed9\u6240\u6709\u54cd\u5e94\u5f0f\u6570\u636e\u589e\u52a0\u6807\u8bc6\uff0c\u5e76\u4e14\u53ef\u4ee5\u5728\u54cd\u5e94\u5f0f\u4e0a\u83b7\u53d6",(0,l.kt)("inlineCode",{parentName:"p"},"Observer"),"\u5b9e\u4f8b\u4e0a\u7684\u65b9\u6cd5")),(0,l.kt)("h5",{id:"4\u6570\u636e\u4ee3\u7406"},"4.\u6570\u636e\u4ee3\u7406"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"function proxy(vm,source,key){\n    Object.defineProperty(vm,key,{\n        get(){\n            return vm[source][key];\n        },\n        set(newValue){\n            vm[source][key] = newValue;\n        }\n    });\n}\nfunction initData(vm){\n    let data = vm.$options.data;\n    data = vm._data = typeof data === 'function' ? data.call(vm) : data;\n    for(let key in data){ // \u5c06_data\u4e0a\u7684\u5c5e\u6027\u5168\u90e8\u4ee3\u7406\u7ed9vm\u5b9e\u4f8b\n        proxy(vm,'_data',key)\n    }\n    observe(data);\n}\n")),(0,l.kt)("h2",{id:"\u4e8c\u6a21\u677f\u7f16\u8bd1"},"\u4e8c\u3001\u6a21\u677f\u7f16\u8bd1"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"Vue.prototype._init = function (options) {\n    const vm = this;\n    vm.$options = options;\n    // \u521d\u59cb\u5316\u72b6\u6001\n    initState(vm);\n    // \u9875\u9762\u6302\u8f7d\n    if (vm.$options.el) {\n        vm.$mount(vm.$options.el);\n    }\n}\nVue.prototype.$mount = function (el) {\n    const vm = this;\n    const options = vm.$options;\n    el = document.querySelector(el);\n\n    // \u5982\u679c\u6ca1\u6709render\u65b9\u6cd5\n    if (!options.render) {\n        let template = options.template;\n        // \u5982\u679c\u6ca1\u6709\u6a21\u677f\u4f46\u662f\u6709el\n        if (!template && el) {\n            template = el.outerHTML;\n        }\n        const render= compileToFunctions(template);\n        options.render = render;\n    }\n}\n")),(0,l.kt)("p",null,"\u5c06",(0,l.kt)("inlineCode",{parentName:"p"},"template"),"\u7f16\u8bd1\u6210",(0,l.kt)("inlineCode",{parentName:"p"},"render\u51fd\u6570")),(0,l.kt)("h5",{id:"1\u89e3\u6790\u6807\u7b7e\u548c\u5185\u5bb9"},"1.\u89e3\u6790\u6807\u7b7e\u548c\u5185\u5bb9"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"const ncname = `[a-zA-Z_][\\\\-\\\\.0-9_a-zA-Z]*`;  \nconst qnameCapture = `((?:${ncname}\\\\:)?${ncname})`;\nconst startTagOpen = new RegExp(`^<${qnameCapture}`); // \u6807\u7b7e\u5f00\u5934\u7684\u6b63\u5219 \u6355\u83b7\u7684\u5185\u5bb9\u662f\u6807\u7b7e\u540d\nconst endTag = new RegExp(`^<\\\\/${qnameCapture}[^>]*>`); // \u5339\u914d\u6807\u7b7e\u7ed3\u5c3e\u7684 </div>\nconst attribute = /^\\s*([^\\s\"'<>\\/=]+)(?:\\s*(=)\\s*(?:\"([^\"]*)\"+|'([^']*)'+|([^\\s\"'=<>`]+)))?/; // \u5339\u914d\u5c5e\u6027\u7684\nconst startTagClose = /^\\s*(\\/?)>/; // \u5339\u914d\u6807\u7b7e\u7ed3\u675f\u7684 >\nconst defaultTagRE = /\\{\\{((?:.|\\r?\\n)+?)\\}\\}/g\nfunction start(tagName,attrs){\n    console.log(tagName,attrs)\n}\nfunction end(tagName){\n    console.log(tagName)\n}\nfunction chars(text){\n    console.log(text);\n}\nfunction parseHTML(html){\n    while(html){\n        let textEnd = html.indexOf('<');\n        if(textEnd == 0){\n            const startTagMatch = parseStartTag();\n            if(startTagMatch){\n                start(startTagMatch.tagName,startTagMatch.attrs);\n                continue;\n            }\n            const endTagMatch = html.match(endTag);\n            if(endTagMatch){\n                advance(endTagMatch[0].length);\n                end(endTagMatch[1]);\n                continue;\n            }\n        }\n        let text;\n        if(textEnd >= 0){\n            text = html.substring(0,textEnd);\n        }\n        if(text){\n            advance(text.length);\n            chars(text);\n        }\n    }\n    function advance(n){\n        html = html.substring(n);\n    }\n    function parseStartTag(){\n        const start = html.match(startTagOpen);\n        if(start){\n            const match = {\n                tagName:start[1],\n                attrs:[]\n            }\n            advance(start[0].length);\n            let attr,end;\n            while(!(end = html.match(startTagClose)) && (attr = html.match(attribute))){\n                advance(attr[0].length);\n                match.attrs.push({name:attr[1],value:attr[3]});\n            }\n            if(end){\n                advance(end[0].length);\n                return match\n            }\n        }\n    }\n}\nexport function compileToFunctions(template){\n    parseHTML(template);\n    return function(){}\n}\n")),(0,l.kt)("h5",{id:"2\u751f\u6210ast\u8bed\u6cd5\u6811"},"2.\u751f\u6210",(0,l.kt)("inlineCode",{parentName:"h5"},"ast"),"\u8bed\u6cd5\u6811"),(0,l.kt)("p",null,"\u8bed\u6cd5\u6811\u5c31\u662f\u7528\u5bf9\u8c61\u63cf\u8ff0",(0,l.kt)("inlineCode",{parentName:"p"},"js"),"\u8bed\u6cd5"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"{\n    tag:'div',\n    type:1,\n    children:[{tag:'span',type:1,attrs:[],parent:'div\u5bf9\u8c61'}],\n    attrs:[{name:'zf',age:10}],\n    parent:null\n}\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"let root;\nlet currentParent;\nlet stack = [];\nconst ELEMENT_TYPE = 1;\nconst TEXT_TYPE = 3;\n\nfunction createASTElement(tagName,attrs){\n    return {\n        tag:tagName,\n        type:ELEMENT_TYPE,\n        children:[],\n        attrs,\n        parent:null\n    }\n}\nfunction start(tagName, attrs) {\n    let element = createASTElement(tagName,attrs);\n    if(!root){\n        root = element;\n    }\n    currentParent = element;\n    stack.push(element);\n}\nfunction end(tagName) {\n    let element = stack.pop();\n    currentParent = stack[stack.length-1];\n    if(currentParent){\n        element.parent = currentParent;\n        currentParent.children.push(element);\n    }\n}\nfunction chars(text) {\n    text = text.replace(/\\s/g,'');\n    if(text){\n        currentParent.children.push({\n            type:TEXT_TYPE,\n            text\n        })\n    }\n}\n")),(0,l.kt)("h5",{id:"3\u751f\u6210\u4ee3\u7801"},"3.\u751f\u6210\u4ee3\u7801"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"template"),"\u8f6c\u5316\u6210render\u51fd\u6570\u7684\u7ed3\u679c"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-html"},"<div style=\"color:red\">hello {{name}} <span></span></div>\nrender(){\n   return _c('div',{style:{color:'red'}},_v('hello'+_s(name)),_c('span',undefined,''))\n}\n")),(0,l.kt)("p",null,"\u5b9e\u73b0\u4ee3\u7801\u751f\u6210"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"function gen(node) {\n    if (node.type == 1) {\n        return generate(node);\n    } else {\n        let text = node.text\n        if(!defaultTagRE.test(text)){\n            return `_v(${JSON.stringify(text)})`\n        }\n        let lastIndex = defaultTagRE.lastIndex = 0\n        let tokens = [];\n        let match,index;\n        \n        while (match = defaultTagRE.exec(text)) {\n            index = match.index;\n            if(index > lastIndex){\n                tokens.push(JSON.stringify(text.slice(lastIndex,index)));\n            }\n            tokens.push(`_s(${match[1].trim()})`)\n            lastIndex = index + match[0].length;\n        }\n        if(lastIndex < text.length){\n            tokens.push(JSON.stringify(text.slice(lastIndex)))\n        }\n        return `_v(${tokens.join('+')})`;\n    }\n}\nfunction getChildren(el) { // \u751f\u6210\u513f\u5b50\u8282\u70b9\n    const children = el.children;\n    if (children) {\n        return `${children.map(c=>gen(c)).join(',')}`\n    } else {\n        return false;\n    }\n}\nfunction genProps(attrs){ // \u751f\u6210\u5c5e\u6027\n    let str = '';\n    for(let i = 0; i<attrs.length; i++){\n        let attr = attrs[i];\n        if(attr.name === 'style'){\n            let obj = {}\n            attr.value.split(';').forEach(item=>{\n                let [key,value] = item.split(':');\n                obj[key] = value;\n            })\n            attr.value = obj;\n        }\n        str += `${attr.name}:${JSON.stringify(attr.value)},`;\n    }\n    return `{${str.slice(0,-1)}}`;\n}\nfunction generate(el) {\n    let children = getChildren(el);\n    let code = `_c('${el.tag}',${\n        el.attrs.length?`${genProps(el.attrs)}`:'undefined'\n    }${\n        children? `,${children}`:''\n    })`;\n    return code;\n}\nlet code = generate(root);\n")),(0,l.kt)("h5",{id:"4\u751f\u6210render\u51fd\u6570"},"4.\u751f\u6210",(0,l.kt)("inlineCode",{parentName:"h5"},"render"),"\u51fd\u6570"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"export function compileToFunctions(template) {\n    parseHTML(template);\n    let code = generate(root);\n    let render = `with(this){return ${code}}`;\n    let renderFn = new Function(render);\n    return renderFn\n}\n")),(0,l.kt)("h2",{id:"\u4e09\u521b\u5efa\u6e32\u67d3watcher"},"\u4e09\u3001\u521b\u5efa\u6e32\u67d3",(0,l.kt)("inlineCode",{parentName:"h2"},"watcher")),(0,l.kt)("h5",{id:"1\u521d\u59cb\u5316\u6e32\u67d3watcher"},"1.\u521d\u59cb\u5316\u6e32\u67d3Watcher"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"import {mountComponent} from './lifecycle'\nVue.prototype.$mount = function (el) {\n    const vm = this;\n    const options = vm.$options;\n    el = document.querySelector(el);\n\n    // \u5982\u679c\u6ca1\u6709render\u65b9\u6cd5\n    if (!options.render) {\n        let template = options.template;\n        // \u5982\u679c\u6ca1\u6709\u6a21\u677f\u4f46\u662f\u6709el\n        if (!template && el) {\n            template = el.outerHTML;\n        }\n\n        const render= compileToFunctions(template);\n        options.render = render;\n    }\n    mountComponent(vm,el);\n}\n")),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"lifecycle.js")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"export function lifecycleMixin() {\n    Vue.prototype._update = function (vnode) {}\n}\nexport function mountComponent(vm, el) {\n    vm.$el = el;\n    let updateComponent = () => {\n        // \u5c06\u865a\u62df\u8282\u70b9 \u6e32\u67d3\u5230\u9875\u9762\u4e0a\n        vm._update(vm._render());\n    }\n    new Watcher(vm, updateComponent, () => {}, true);\n}\n")),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"render.js")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"export function renderMixin(Vue){\n    Vue.prototype._render = function () {}\n}\n")),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"watcher.js")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"let id = 0;\nclass Watcher {\n    constructor(vm, exprOrFn, cb, options) {\n        this.vm = vm;\n        this.exprOrFn = exprOrFn;\n        if (typeof exprOrFn == 'function') {\n            this.getter = exprOrFn;\n        }\n        this.cb = cb;\n        this.options = options;\n        this.id = id++;\n        this.get();\n    }\n    get() {\n        this.getter();\n    }\n}\n\nexport default Watcher;\n")),(0,l.kt)("p",null,"\u5148\u8c03\u7528",(0,l.kt)("inlineCode",{parentName:"p"},"_render"),"\u65b9\u6cd5\u751f\u6210\u865a\u62df",(0,l.kt)("inlineCode",{parentName:"p"},"dom"),",\u901a\u8fc7",(0,l.kt)("inlineCode",{parentName:"p"},"_update"),"\u65b9\u6cd5\u5c06\u865a\u62df",(0,l.kt)("inlineCode",{parentName:"p"},"dom"),"\u521b\u5efa\u6210\u771f\u5b9e\u7684",(0,l.kt)("inlineCode",{parentName:"p"},"dom")),(0,l.kt)("h5",{id:"2\u751f\u6210\u865a\u62dfdom"},"2.\u751f\u6210\u865a\u62df",(0,l.kt)("inlineCode",{parentName:"h5"},"dom")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"import {createTextNode,createElement} from './vdom/create-element'\nexport function renderMixin(Vue){\n    Vue.prototype._v = function (text) { // \u521b\u5efa\u6587\u672c\n        return createTextNode(text);\n    }\n    Vue.prototype._c = function () { // \u521b\u5efa\u5143\u7d20\n        return createElement(...arguments);\n    }\n    Vue.prototype._s = function (val) {\n        return val == null? '' : (typeof val === 'object'?JSON.stringify(val):val);\n    }\n    Vue.prototype._render = function () {\n        const vm = this;\n        const {render} = vm.$options;\n        let vnode = render.call(vm);\n        return vnode;\n    }\n}\n")),(0,l.kt)("p",null,"\u521b\u5efa\u865a\u62df\u8282\u70b9"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"export function createTextNode(text) {\n    return vnode(undefined,undefined,undefined,undefined,text)\n}\nexport function createElement(tag,data={},...children){\n    let key = data.key;\n    if(key){\n        delete data.key;\n    }\n    return vnode(tag,data,key,children);\n}\nfunction vnode(tag,data,key,children,text){\n    return {\n        tag,\n        data,\n        key,\n        children,\n        text\n    }\n}\n")),(0,l.kt)("h5",{id:"3\u751f\u6210\u771f\u5b9edom\u5143\u7d20"},"3.\u751f\u6210\u771f\u5b9e",(0,l.kt)("inlineCode",{parentName:"h5"},"DOM"),"\u5143\u7d20"),(0,l.kt)("p",null,"\u5c06\u865a\u62df\u8282\u70b9\u6e32\u67d3\u6210\u771f\u5b9e\u8282\u70b9"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"import {patch} './observer/patch'\nexport function lifecycleMixin(Vue){\n    Vue.prototype._update = function (vnode) {\n        const vm = this;\n        vm.$el = patch(vm.$el,vnode);\n    }\n}\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"export function patch(oldVnode,vnode){\n    const isRealElement = oldVnode.nodeType;\n    if(isRealElement){\n        const oldElm = oldVnode;\n        const parentElm = oldElm.parentNode;\n        \n        let el = createElm(vnode);\n        parentElm.insertBefore(el,oldElm.nextSibling);\n        parentElm.removeChild(oldVnode)\n        return el;\n    } \n}\nfunction createElm(vnode){\n    let {tag,children,key,data,text} = vnode;\n    if(typeof tag === 'string'){\n        vnode.el = document.createElement(tag);\n        updateProperties(vnode);\n        children.forEach(child => { \n            return vnode.el.appendChild(createElm(child));\n        });\n    }else{\n        vnode.el = document.createTextNode(text);\n    }\n    return vnode.el\n}\nfunction updateProperties(vnode){\n    let newProps = vnode.data || {}; // \u83b7\u53d6\u5f53\u524d\u8001\u8282\u70b9\u4e2d\u7684\u5c5e\u6027 \n    let el = vnode.el; // \u5f53\u524d\u7684\u771f\u5b9e\u8282\u70b9\n    for(let key in newProps){\n        if(key === 'style'){ \n            for(let styleName in newProps.style){\n                el.style[styleName] = newProps.style[styleName]\n            }\n        }else if(key === 'class'){\n            el.className= newProps.class\n        }else{ // \u7ed9\u8fd9\u4e2a\u5143\u7d20\u6dfb\u52a0\u5c5e\u6027 \u503c\u5c31\u662f\u5bf9\u5e94\u7684\u503c\n            el.setAttribute(key,newProps[key]);\n        }\n    }\n}\n")),(0,l.kt)("h2",{id:"\u56db\u751f\u547d\u5468\u671f\u7684\u5408\u5e76"},"\u56db\u3001\u751f\u547d\u5468\u671f\u7684\u5408\u5e76"),(0,l.kt)("h5",{id:"1mixin\u539f\u7406"},"1.Mixin\u539f\u7406"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"import {mergeOptions} from '../util/index.js'\nexport function initGlobalAPI(Vue){\n    Vue.options = {};\n\n    Vue.mixin = function (mixin) {\n        // \u5c06\u5c5e\u6027\u5408\u5e76\u5230Vue.options\u4e0a\n        this.options = mergeOptions(this.options,mixin);\n        return this;\n    }\n}\n")),(0,l.kt)("h5",{id:"2\u5408\u5e76\u751f\u547d\u5468\u671f"},"2.\u5408\u5e76\u751f\u547d\u5468\u671f"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"export const LIFECYCLE_HOOKS = [\n    'beforeCreate',\n    'created',\n    'beforeMount',\n    'mounted',\n    'beforeUpdate',\n    'updated',\n    'beforeDestroy',\n    'destroyed',\n]\nconst strats = {};\nfunction mergeHook(parentVal, childValue) {\n    if (childValue) {\n        if (parentVal) {\n            return parentVal.concat(childValue);\n        } else {\n            return [childValue]\n        }\n    } else {\n        return parentVal;\n    }\n}\nLIFECYCLE_HOOKS.forEach(hook => {\n    strats[hook] = mergeHook\n})\nexport function mergeOptions(parent, child) {\n    const options = {}\n    for (let key in parent) {\n        mergeField(key)\n    }\n    for (let key in child) {\n        if (!parent.hasOwnProperty(key)) {\n            mergeField(key);\n        }\n    }\n    function mergeField(key) {\n        if (strats[key]) {\n            options[key] = strats[key](parent[key], child[key]);\n        } else {\n            if (typeof parent[key] == 'object' && typeof child[key] == 'object') {\n                options[key] = {\n                    ...parent[key],\n                    ...child[key]\n                }\n            }else{\n                options[key] = child[key];\n            }\n        }\n    }\n    return options\n}\n")),(0,l.kt)("h5",{id:"3\u8c03\u7528\u751f\u547d\u5468\u671f"},"3.\u8c03\u7528\u751f\u547d\u5468\u671f"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"export function callHook(vm, hook) {\n    const handlers = vm.$options[hook];\n    if (handlers) {\n        for (let i = 0; i < handlers.length; i++) {\n            handlers[i].call(vm);\n        }\n    }\n}\n")),(0,l.kt)("h5",{id:"4\u521d\u59cb\u5316\u6d41\u7a0b\u4e2d\u8c03\u7528\u751f\u547d\u5468\u671f"},"4.\u521d\u59cb\u5316\u6d41\u7a0b\u4e2d\u8c03\u7528\u751f\u547d\u5468\u671f"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"Vue.prototype._init = function (options) {\n    const vm = this;\n    vm.$options = mergeOptions(vm.constructor.options,options);\n    // \u521d\u59cb\u5316\u72b6\u6001\n    callHook(vm,'beforeCreate');\n    initState(vm);\n    callHook(vm,'created');\n    if (vm.$options.el) {\n        vm.$mount(vm.$options.el);\n    }\n}\n")),(0,l.kt)("h2",{id:"\u4e94\u4f9d\u8d56\u6536\u96c6"},"\u4e94\u3001\u4f9d\u8d56\u6536\u96c6"),(0,l.kt)("p",null,"\u6bcf\u4e2a\u5c5e\u6027\u90fd\u8981\u6709\u4e00\u4e2a",(0,l.kt)("inlineCode",{parentName:"p"},"dep"),",\u6bcf\u4e2a",(0,l.kt)("inlineCode",{parentName:"p"},"dep"),"\u4e2d\u5b58\u653e\u7740",(0,l.kt)("inlineCode",{parentName:"p"},"watcher"),",\u540c\u4e00\u4e2a",(0,l.kt)("inlineCode",{parentName:"p"},"watcher"),"\u4f1a\u88ab\u591a\u4e2a",(0,l.kt)("inlineCode",{parentName:"p"},"dep"),"\u6240\u8bb0\u5f55\u3002"),(0,l.kt)("h5",{id:"1\u5728\u6e32\u67d3\u65f6\u5b58\u50a8watcher"},"1.\u5728\u6e32\u67d3\u65f6\u5b58\u50a8watcher"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"class Watcher{\n    // ...\n    get(){\n        pushTarget(this);\n        this.getter();\n        popTarget();\n    }\n}\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"let id = 0;\nclass Dep{\n    constructor(){\n        this.id = id++;\n    }\n}\nlet stack = [];\nexport function pushTarget(watcher){\n    Dep.target = watcher;\n    stack.push(watcher);\n}\nexport function popTarget(){\n    stack.pop();\n    Dep.target = stack[stack.length-1];\n}\nexport default Dep;\n")),(0,l.kt)("h5",{id:"2\u5bf9\u8c61\u4f9d\u8d56\u6536\u96c6"},"2.\u5bf9\u8c61\u4f9d\u8d56\u6536\u96c6"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"let dep = new Dep();\nObject.defineProperty(data, key, {\n    get() {\n        if(Dep.target){ // \u5982\u679c\u53d6\u503c\u65f6\u6709watcher\n            dep.depend(); // \u8ba9watcher\u4fdd\u5b58dep\uff0c\u5e76\u4e14\u8ba9dep \u4fdd\u5b58watcher\n        }\n        return value\n    },\n    set(newValue) {\n        if (newValue == value) return;\n        observe(newValue);\n        value = newValue;\n        dep.notify(); // \u901a\u77e5\u6e32\u67d3watcher\u53bb\u66f4\u65b0\n    }\n});\n")),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"Dep\u5b9e\u73b0")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"class Dep{\n    constructor(){\n        this.id = id++;\n        this.subs = [];\n    }\n    depend(){\n        if(Dep.target){\n            Dep.target.addDep(this);// \u8ba9watcher,\u53bb\u5b58\u653edep\n        }\n    }\n    notify(){\n        this.subs.forEach(watcher=>watcher.update());\n    }\n    addSub(watcher){\n        this.subs.push(watcher);\n    }\n}\n")),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"watcher")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"constructor(){\n    this.deps = [];\n    this.depsId = new Set();\n}\naddDep(dep){\n    let id = dep.id;\n    if(!this.depsId.has(id)){\n        this.depsId.add(id);\n        this.deps.push(dep);\n        dep.addSub(this);\n    }\n}\nupdate(){\n    this.get();\n}\n")),(0,l.kt)("h5",{id:"3\u6570\u7ec4\u7684\u4f9d\u8d56\u6536\u96c6"},"3.\u6570\u7ec4\u7684\u4f9d\u8d56\u6536\u96c6"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"this.dep = new Dep(); // \u4e13\u95e8\u4e3a\u6570\u7ec4\u8bbe\u8ba1\u7684\nif (Array.isArray(value)) {\n    value.__proto__ = arrayMethods;\n    this.observeArray(value);\n} else {\n    this.walk(value);\n}   \n\nfunction defineReactive(data, key, value) {\n    let childOb = observe(value);\n    let dep = new Dep();\n    Object.defineProperty(data, key, {\n        get() {\n            if(Dep.target){\n                dep.depend();\n                if(childOb){ \n                    childOb.dep.depend(); // \u6536\u96c6\u6570\u7ec4\u4f9d\u8d56\n                }\n            }\n            return value\n        },\n        set(newValue) {\n            if (newValue == value) return;\n            observe(newValue);\n            value = newValue;\n            dep.notify();\n        }\n    })\n}\n\n\narrayMethods[method] = function (...args) {\n        // ...\n        ob.dep.notify()\n        return result;\n}\n")),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"\u9012\u5f52\u6536\u96c6\u6570\u7ec4\u4f9d\u8d56")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"if(Dep.target){\n    dep.depend();\n    if(childOb){\n        childOb.dep.depend(); // \u6536\u96c6\u6570\u7ec4\u4f9d\u8d56\n        if(Array.isArray(value)){ // \u5982\u679c\u5185\u90e8\u8fd8\u662f\u6570\u7ec4\n            dependArray(value);// \u4e0d\u505c\u7684\u8fdb\u884c\u4f9d\u8d56\u6536\u96c6\n        }\n    }\n}\nfunction dependArray(value) {\n    for (let i = 0; i < value.length; i++) {\n        let current = value[i];\n        current.__ob__ && current.__ob__.dep.depend();\n        if (Array.isArray(current)) {\n            dependArray(current)\n        }\n    }\n}\n")),(0,l.kt)("h2",{id:"\u516d\u5b9e\u73b0vue\u5f02\u6b65\u66f4\u65b0\u4e4bnexttick"},"\u516d.\u5b9e\u73b0Vue\u5f02\u6b65\u66f4\u65b0\u4e4b",(0,l.kt)("inlineCode",{parentName:"h2"},"nextTick")),(0,l.kt)("h5",{id:"1\u5b9e\u73b0\u961f\u5217\u673a\u5236"},"1.\u5b9e\u73b0\u961f\u5217\u673a\u5236"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"update(){\n    queueWatcher(this);\n}\n")),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"scheduler")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"import {\n    nextTick\n} from '../util/next-tick'\nlet has = {};\nlet queue = [];\n\nfunction flushSchedulerQueue() {\n    for (let i = 0; i < queue.length; i++) {\n        let watcher = queue[i];\n        watcher.run()\n    }\n    queue = [];\n    has = {}\n}\nlet pending = false\nexport function queueWatcher(watcher) {\n    const id = watcher.id;\n    if (has[id] == null) {\n        has[id] = true;\n        queue.push(watcher);\n        if(!pending){\n            nextTick(flushSchedulerQueue)\n            pending = true;\n        }\n    }\n}\n")),(0,l.kt)("h5",{id:"2nexttick\u5b9e\u73b0\u539f\u7406"},"2.nextTick\u5b9e\u73b0\u539f\u7406"),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"util/next-tick.js")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"let callbacks = [];\nfunction flushCallbacks() {\n    callbacks.forEach(cb => cb());\n}\nlet timerFunc;\nif (Promise) { // then\u65b9\u6cd5\u662f\u5f02\u6b65\u7684\n    timerFunc = () => {\n        Promise.resolve().then(flushCallbacks)\n    }\n}else if (MutationObserver) { // MutationObserver \u4e5f\u662f\u4e00\u4e2a\u5f02\u6b65\u65b9\u6cd5\n    let observe = new MutationObserver(flushCallbacks); // H5\u7684api\n    let textNode = document.createTextNode(1);\n    observe.observe(textNode, {\n        characterData: true\n    });\n    timerFunc = () => {\n        textNode.textContent = 2;\n    }\n}else if (setImmediate) {\n    timerFunc = () => {\n        setImmediate(flushCallbacks)\n    }\n}else{\n    timerFunc = () => {\n        setTimeout(flushCallbacks, 0);\n    }\n}\nexport function nextTick(cb) {\n    callbacks.push(cb);\n    timerFunc();\n}\n")),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"img",src:t(9850).Z,width:"955",height:"695"})),(0,l.kt)("h2",{id:"\u4e03watch--computed"},"\u4e03\u3001Watch & Computed"),(0,l.kt)("h5",{id:"1watch\u5b9e\u73b0\u539f\u7406"},"1.Watch\u5b9e\u73b0\u539f\u7406"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"let vm = new Vue({\n    el: '#app',\n    data(){\n        return {name:'zf'}\n    },\n    watch:{\n        name(newValue,oldValue){\n            console.log(newValue,oldValue);\n        }\n    }\n});\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"watch\u7528\u4e8e\u76d1\u63a7\u7528\u6237\u7684data\u53d8\u5316\uff0c\u6570\u636e\u53d8\u5316\u540e\u4f1a\u89e6\u53d1\u5bf9\u5e94\u7684watch\u7684\u56de\u8c03\u65b9\u6cd5")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"if (opts.watch) {\n    initWatch(vm,opts.watch);\n}\n")),(0,l.kt)("p",null,"\u9009\u9879\u4e2d\u5982\u679c\u6709watch\u5219\u5bf9watch\u8fdb\u884c\u521d\u59cb\u5316"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"function initWatch(vm, watch) {\n    for (const key in watch) {\n        const handler = watch[key];\n        // \u5982\u679c\u7ed3\u679c\u503c\u662f\u6570\u7ec4\u5faa\u73af\u521b\u5efawatcher\n        if (Array.isArray(handler)) {\n            for (let i = 0; i < handler.length; i++) {\n                createWatcher(vm,key,handler[i]);\n            }\n        }else{\n            createWatcher(vm,key,handler)\n        }\n    }\n}\nfunction createWatcher(vm,exprOrFn,handler,options){\n    // \u5982\u679c\u662f\u5bf9\u8c61\u5219\u63d0\u53d6\u51fd\u6570 \u548c\u914d\u7f6e\n    if(isObject(handler)){\n        options = handler;\n        handler = handler.handler;\n    }\n    // \u5982\u679c\u662f\u5b57\u7b26\u4e32\u5c31\u662f\u5b9e\u4f8b\u4e0a\u7684\u51fd\u6570\n    if(typeof handler == 'string'){\n        handler = vm[handler];\n    }\n    return vm.$watch(exprOrFn,handler,options);\n}\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u8fd9\u91cc\u6d89\u53ca\u4e86watch\u7684\u4e09\u79cd\u5199\u6cd5,1.\u503c\u662f\u5bf9\u8c61\u30012.\u503c\u662f\u6570\u7ec4\u30013.\u503c\u662f\u5b57\u7b26\u4e32 \uff08\u5982\u679c\u662f\u5bf9\u8c61\u53ef\u4ee5\u4f20\u5165\u4e00\u4e9bwatch\u53c2\u6570\uff09\uff0c\u6700\u7ec8\u4f1a\u8c03\u7528vm.$watch\u6765\u5b9e\u73b0")),(0,l.kt)("p",null,"\u6269\u5c55Vue\u539f\u578b\u4e0a\u7684\u65b9\u6cd5\uff0c\u90fd\u901a\u8fc7mixin\u7684\u65b9\u5f0f\u6765\u8fdb\u884c\u6dfb\u52a0\u7684\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"stateMixin(Vue);\nexport function stateMixin(Vue) {\n    Vue.prototype.$watch = function(exprOrFn, cb, options = {}) {\n        options.user = true; // \u6807\u8bb0\u4e3a\u7528\u6237watcher\n        // \u6838\u5fc3\u5c31\u662f\u521b\u5efa\u4e2awatcher\n        const watcher = new Watcher(this, exprOrFn, cb, options);\n        if(options.immediate){\n            cb.call(vm,watcher.value)\n        }\n    }\n}\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"class Watcher {\n    constructor(vm, exprOrFn, callback, options) {\n        // ...\n        this.user = !! options.user\n        if(typeof exprOrFn === 'function'){\n            this.getter = exprOrFn; \n        }else{\n            this.getter = function (){ // \u5c06\u8868\u8fbe\u5f0f\u8f6c\u6362\u6210\u51fd\u6570\n                let path = exprOrFn.split('.');\n                let obj = vm;\n                for(let i = 0; i < path.length;i++){\n                    obj = obj[path[i]];\n                }\n                return obj;\n            }\n        }\n        this.value = this.get(); // \u5c06\u521d\u59cb\u503c\u8bb0\u5f55\u5230value\u5c5e\u6027\u4e0a\n    }\n    get() {\n        pushTarget(this); // \u628a\u7528\u6237\u5b9a\u4e49\u7684watcher\u5b58\u8d77\u6765  \n        const value = this.getter.call(this.vm); // \u6267\u884c\u51fd\u6570 \uff08\u4f9d\u8d56\u6536\u96c6\uff09\n        popTarget(); // \u79fb\u9664watcher\n        return value;\n    }\n    run(){\n        let value = this.get();    // \u83b7\u53d6\u65b0\u503c\n        let oldValue = this.value; // \u83b7\u53d6\u8001\u503c\n        this.value = value;\n        if(this.user){ // \u5982\u679c\u662f\u7528\u6237watcher \u5219\u8c03\u7528\u7528\u6237\u4f20\u5165\u7684callback\n            this.callback.call(this.vm,value,oldValue)\n        }\n    }\n}\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u8fd8\u662f\u501f\u52a9Vue\u54cd\u5e94\u5f0f\u539f\u7406\uff0c\u9ed8\u8ba4\u5728\u53d6\u503c\u65f6\u5c06watcher\u5b58\u653e\u5230\u5bf9\u5e94\u5c5e\u6027\u7684dep\u4e2d\uff0c\u5f53\u6570\u636e\u53d1\u751f\u53d8\u5316\u65f6\u901a\u77e5\u5bf9\u5e94\u7684watcher\u91cd\u65b0\u6267\u884c")),(0,l.kt)("h5",{id:"2computed\u5b9e\u73b0\u539f\u7406"},"2.Computed\u5b9e\u73b0\u539f\u7406"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"if (opts.computed) {\n    initComputed(vm,opts.computed);\n}\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"function initComputed(vm, computed) {\n    // \u5b58\u653e\u8ba1\u7b97\u5c5e\u6027\u7684watcher\n    const watchers = vm._computedWatchers = {};\n    for (const key in computed) {\n        const userDef = computed[key];\n        // \u83b7\u53d6get\u65b9\u6cd5\n        const getter = typeof userDef === 'function' ? userDef : userDef.get;\n        // \u521b\u5efa\u8ba1\u7b97\u5c5e\u6027watcher\n        watchers[key] = new Watcher(vm, userDef, () => {}, { lazy: true });\n        defineComputed(vm, key, userDef)\n    }\n}\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u6bcf\u4e2a\u8ba1\u7b97\u5c5e\u6027\u4e5f\u90fd\u662f\u4e00\u4e2a",(0,l.kt)("inlineCode",{parentName:"p"},"watcher"),",\u8ba1\u7b97\u5c5e\u6027\u9700\u8981\u8868\u793alazy:true,\u8fd9\u6837\u5728\u521d\u59cb\u5316watcher\u65f6\u4e0d\u4f1a\u7acb\u5373\u8c03\u7528\u8ba1\u7b97\u5c5e\u6027\u65b9\u6cd5")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"class Watcher {\n    constructor(vm, exprOrFn, callback, options) {\n        this.vm = vm;\n        this.dirty = this.lazy\n        // ...\n        this.value = this.lazy ? undefined : this.get(); // \u8c03\u7528get\u65b9\u6cd5 \u4f1a\u8ba9\u6e32\u67d3watcher\u6267\u884c\n    }\n}\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u9ed8\u8ba4\u8ba1\u7b97\u5c5e\u6027\u9700\u8981\u4fdd\u5b58\u4e00\u4e2adirty\u5c5e\u6027\uff0c\u7528\u6765\u5b9e\u73b0\u7f13\u5b58\u529f\u80fd")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"function defineComputed(target, key, userDef) {\n    if (typeof userDef === 'function') {\n        sharedPropertyDefinition.get = createComputedGetter(key)\n    } else {\n        sharedPropertyDefinition.get = createComputedGetter(userDef.get);\n        sharedPropertyDefinition.set = userDef.set;\n    }\n    // \u4f7f\u7528defineProperty\u5b9a\u4e49\n    Object.defineProperty(target, key, sharedPropertyDefinition)\n}\n")),(0,l.kt)("p",null,"\u521b\u5efa\u7f13\u5b58getter"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"function createComputedGetter(key) {\n    return function computedGetter() {\n        const watcher = this._computedWatchers[key];\n        if (watcher) {\n            if (watcher.dirty) { // \u5982\u679cdirty\u4e3atrue\n                watcher.evaluate();// \u8ba1\u7b97\u51fa\u65b0\u503c\uff0c\u5e76\u5c06dirty \u66f4\u65b0\u4e3afalse\n            }\n            // \u5982\u679c\u4f9d\u8d56\u7684\u503c\u4e0d\u53d1\u751f\u53d8\u5316\uff0c\u5219\u8fd4\u56de\u4e0a\u6b21\u8ba1\u7b97\u7684\u7ed3\u679c\n            return watcher.value\n        }\n    }\n}\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"watcher.evaluate\nevaluate() {\n    this.value = this.get()\n    this.dirty = false\n}\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"update() {\n    if (this.lazy) {\n        this.dirty = true;\n    } else {\n        queueWatcher(this);\n    }\n}\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u5f53\u4f9d\u8d56\u7684\u5c5e\u6027\u53d8\u5316\u65f6\uff0c\u4f1a\u901a\u77e5watcher\u8c03\u7528update\u65b9\u6cd5\uff0c\u6b64\u65f6\u6211\u4eec\u5c06dirty\u7f6e\u6362\u4e3atrue\u3002\u8fd9\u6837\u518d\u53d6\u503c\u65f6\u4f1a\u91cd\u65b0\u8fdb\u884c\u8ba1\u7b97\u3002")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"if (watcher) {\n    if (watcher.dirty) {\n        watcher.evaluate();\n    }\n    if (Dep.target) { // \u8ba1\u7b97\u5c5e\u6027\u5728\u6a21\u677f\u4e2d\u4f7f\u7528 \u5219\u5b58\u5728Dep.target\n        watcher.depend()\n    }\n    return watcher.value\n}\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"depend() {\n    let i = this.deps.length\n    while (i--) {\n        this.deps[i].depend()\n    }\n}\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u5982\u679c\u8ba1\u7b97\u5c5e\u6027\u5728\u6a21\u677f\u4e2d\u4f7f\u7528\uff0c\u5c31\u8ba9\u8ba1\u7b97\u5c5e\u6027\u4e2d\u4f9d\u8d56\u7684\u6570\u636e\u4e5f\u8bb0\u5f55\u6e32\u67d3watcher,\u8fd9\u6837\u4f9d\u8d56\u7684\u5c5e\u6027\u53d1\u751f\u53d8\u5316\u4e5f\u53ef\u4ee5\u8ba9\u89c6\u56fe\u8fdb\u884c\u5237\u65b0")),(0,l.kt)("h2",{id:"\u516bvue\u7ec4\u4ef6\u539f\u7406\u89e3\u6790"},"\u516b\u3001Vue\u7ec4\u4ef6\u539f\u7406\u89e3\u6790"),(0,l.kt)("h5",{id:"1\u5168\u5c40\u7ec4\u4ef6\u7684\u89e3\u6790"},"1.\u5168\u5c40\u7ec4\u4ef6\u7684\u89e3\u6790"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-html"},"<div id=\"app\">\n    <my-component></my-component>\n    <my-component></my-component>\n</div>\n<script>\nVue.component('my-component',{\n    template:'<button>\u70b9\u6211</button>',\n});\nlet vm = new Vue({\n    el:'#app'\n});\n<\/script>\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7",(0,l.kt)("inlineCode",{parentName:"p"},"Vue.component"),"\u6ce8\u518c\u5168\u5c40\u7ec4\u4ef6\uff0c\u4e4b\u540e\u53ef\u4ee5\u5728\u6a21\u677f\u4e2d\u8fdb\u884c\u4f7f\u7528")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"export function initGlobalAPI(Vue){\n    // \u6574\u5408\u4e86\u6240\u6709\u7684\u5168\u5c40\u76f8\u5173\u7684\u5185\u5bb9\n    Vue.options ={}\n    initMixin(Vue);\n\n    // _base \u5c31\u662fVue\u7684\u6784\u9020\u51fd\u6570\n    Vue.options._base = Vue;\n    Vue.options.components = {}\n\n    // \u6ce8\u518cAPI\u65b9\u6cd5\n    initAssetRegisters(Vue);\n}\n")),(0,l.kt)("h6",{id:"1vuecomponent\u65b9\u6cd5"},"1.",(0,l.kt)("inlineCode",{parentName:"h6"},"Vue.component"),"\u65b9\u6cd5"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"export default function initAssetRegisters(Vue) {\n    Vue.component = function (id, definition) {\n        definition.name = definition.name || id;\n        definition = this.options._base.extend(definition);\n        this.options['components'][id] = definition;\n    }\n}\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},(0,l.kt)("inlineCode",{parentName:"p"},"Vue.component"),"\u5185\u90e8\u4f1a\u8c03\u7528",(0,l.kt)("inlineCode",{parentName:"p"},"Vue.extend"),"\u65b9\u6cd5\uff0c\u5c06\u5b9a\u4e49\u6302\u8f7d\u5230",(0,l.kt)("inlineCode",{parentName:"p"},"Vue.options.components"),"\u4e0a\u3002\u8fd9\u4e5f\u8bf4\u660e\u6240\u6709\u7684\u5168\u5c40\u7ec4\u4ef6\u6700\u7ec8\u90fd\u4f1a\u6302\u8f7d\u5230\u8fd9\u4e2a\u53d8\u91cf\u4e0a")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"export function initGlobalAPI(Vue){\n    // \u6574\u5408\u4e86\u6240\u6709\u7684\u5168\u5c40\u76f8\u5173\u7684\u5185\u5bb9\n    Vue.options ={}\n    initMixin(Vue);\n    // _base \u5c31\u662fVue\u7684\u6784\u9020\u51fd\u6570\n    Vue.options._base = Vue;\n    Vue.options.components = {}\n\n    // initExtend\n+   initExtend(Vue);\n\n    // \u6ce8\u518cAPI\u65b9\u6cd5\n    initAssetRegisters(Vue);\n}\n")),(0,l.kt)("h6",{id:"2vueextend\u65b9\u6cd5"},"2.",(0,l.kt)("inlineCode",{parentName:"h6"},"Vue.extend"),"\u65b9\u6cd5"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"import {mergeOptions} from '../util/index'\nexport default function initExtend(Vue) {\n    let cid = 0;\n    Vue.extend = function (extendOptions) {\n        const Super = this;\n        const Sub = function VueComponent(options) {\n            this._init(options)\n        }\n        Sub.cid = cid++;\n        Sub.prototype = Object.create(Super.prototype);\n        Sub.prototype.constructor = Sub;\n        Sub.options = mergeOptions(\n            Super.options,\n            extendOptions\n        );\n        return Sub\n    }\n}\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},(0,l.kt)("inlineCode",{parentName:"p"},"extend"),"\u65b9\u6cd5\u5c31\u662f\u521b\u5efa\u51fa\u4e00\u4e2a\u5b50\u7c7b\uff0c\u7ee7\u627f\u4e8e",(0,l.kt)("inlineCode",{parentName:"p"},"Vue"),",\u5e76\u8fd4\u56de\u8fd9\u4e2a\u7c7b")),(0,l.kt)("h6",{id:"3\u5c5e\u6027\u5408\u5e76"},"3.\u5c5e\u6027\u5408\u5e76"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"function mergeAssets(parentVal,childVal){\n    const res = Object.create(parentVal);\n    if(childVal){\n        for(let key in childVal){\n            res[key] = childVal[key];\n        }\n    }\n    return res;\n}\nstrats.components = mergeAssets;\n")),(0,l.kt)("h6",{id:"4\u521d\u59cb\u5316\u5408\u5e76"},"4.\u521d\u59cb\u5316\u5408\u5e76"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"vm.$options = mergeOptions(vm.constructor.options,options);\n")),(0,l.kt)("h5",{id:"2\u7ec4\u4ef6\u7684\u6e32\u67d3"},"2.\u7ec4\u4ef6\u7684\u6e32\u67d3"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"function makeMap(str) {\n    const map = {};\n    const list = str.split(',');\n    for (let i = 0; i < list.length; i++) {\n        map[list[i]] = true;\n    }\n    return (key)=>map[key];\n}\n\nexport const isReservedTag = makeMap(\n    'a,div,img,image,text,span,input,p,button'\n)\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u5728\u521b\u5efa\u865a\u62df\u8282\u70b9\u65f6\u6211\u4eec\u8981\u5224\u65ad\u5f53\u524d\u8fd9\u4e2a\u6807\u7b7e\u662f\u5426\u662f\u7ec4\u4ef6\uff0c\u666e\u901a\u6807\u7b7e\u7684\u865a\u62df\u8282\u70b9\u548c\u7ec4\u4ef6\u7684\u865a\u62df\u8282\u70b9\u6709\u6240\u4e0d\u540c")),(0,l.kt)("h6",{id:"1\u521b\u5efa\u7ec4\u4ef6\u865a\u62df\u8282\u70b9"},"1.\u521b\u5efa\u7ec4\u4ef6\u865a\u62df\u8282\u70b9"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"export function createElement(vm,tag, data = {}, ...children) {\n    let key = data.key;\n    if (key) {\n        delete data.key;\n    }\n    if (typeof tag === 'string') {\n        if (isReservedTag(tag)) {\n            return vnode(tag, data, key, children, undefined);\n        } else {\n            // \u5982\u679c\u662f\u7ec4\u4ef6\u9700\u8981\u62ff\u5230\u7ec4\u4ef6\u7684\u5b9a\u4e49,\u901a\u8fc7\u7ec4\u4ef6\u7684\u5b9a\u4e49\u521b\u9020\u865a\u62df\u8282\u70b9\n            let Ctor = vm.$options.components[tag];\n            return createComponent(vm,tag,data,key,children,Ctor)\n        }\n    }\n}\nfunction createComponent(vm,tag,data,key,children,Ctor){\n    // \u83b7\u53d6\u7236\u7c7b\u6784\u9020\u51fd\u6570t \n    const baseCtor = vm.$options._base; \n    if(isObject(Ctor)){\n        Ctor = baseCtor.extend(Ctor);\n    }\n    data.hook = { // \u7ec4\u4ef6\u7684\u751f\u547d\u5468\u671f\u94a9\u5b50\n        init(){}\n    }\n    return vnode(`vue-component-${Ctor.cid}-${tag}`,data,key,undefined,{Ctor,children});\n}\nfunction vnode(tag, data, key, children, text, componentOptions) {\n    return {tag, data, key, children, text, componentOptions}\n}\n")),(0,l.kt)("h6",{id:"2\u521b\u5efa\u7ec4\u4ef6\u7684\u771f\u5b9e\u8282\u70b9"},"2.\u521b\u5efa\u7ec4\u4ef6\u7684\u771f\u5b9e\u8282\u70b9"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"export function patch(oldVnode,vnode){\n    // 1.\u5224\u65ad\u662f\u66f4\u65b0\u8fd8\u662f\u8981\u6e32\u67d3\n    if(!oldVnode){\n        return createElm(vnode);\n    }else{\n        // ...\n    }\n}\nfunction createElm(vnode){ // \u6839\u636e\u865a\u62df\u8282\u70b9\u521b\u5efa\u771f\u5b9e\u7684\u8282\u70b9\n    let {tag,children,key,data,text} = vnode;\n    // \u662f\u6807\u7b7e\u5c31\u521b\u5efa\u6807\u7b7e\n    if(typeof tag === 'string'){\n        // createElm\u9700\u8981\u8fd4\u56de\u771f\u5b9e\u8282\u70b9\n        if(createComponent(vnode)){\n            return vnode.componentInstance.$el;\n        }\n        vnode.el = document.createElement(tag);\n        updateProperties(vnode);\n        children.forEach(child=>{ // \u9012\u5f52\u521b\u5efa\u513f\u5b50\u8282\u70b9\uff0c\u5c06\u513f\u5b50\u8282\u70b9\u6254\u5230\u7236\u8282\u70b9\u4e2d\n            return vnode.el.appendChild(createElm(child))\n        })\n    }else{\n        // \u865a\u62dfdom\u4e0a\u6620\u5c04\u7740\u771f\u5b9edom  \u65b9\u4fbf\u540e\u7eed\u66f4\u65b0\u64cd\u4f5c\n        vnode.el = document.createTextNode(text)\n    }\n    // \u5982\u679c\u4e0d\u662f\u6807\u7b7e\u5c31\u662f\u6587\u672c\n    return vnode.el;\n}\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"function createComponent(vnode) {\n    let i = vnode.data;\n    if((i = i.hook) && (i = i.init)){\n        i(vnode);\n    }\n    if(vnode.componentInstance){\n        return true;\n    }\n}\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u8c03\u7528",(0,l.kt)("inlineCode",{parentName:"p"},"init"),"\u65b9\u6cd5,\u8fdb\u884c\u7ec4\u4ef6\u7684\u521d\u59cb\u5316")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"data.hook = {\n    init(vnode){\n        let child = vnode.componentInstance = new Ctor({});\n        child.$mount(); // \u7ec4\u4ef6\u7684\u6302\u8f7d\n    }\n}\n")),(0,l.kt)("h2",{id:"\u4e5dvue\u4e2ddiff\u7b97\u6cd5\u89e3\u6790"},"\u4e5d\u3001Vue\u4e2dDiff\u7b97\u6cd5\u89e3\u6790"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"import {compileToFunction} from './compiler/index.js';\nimport { patch,createElm } from './vdom/patch';\n// 1.\u521b\u5efa\u7b2c\u4e00\u4e2a\u865a\u62df\u8282\u70b9\nlet vm1 = new Vue({data:{name:'zf'}});\nlet render1 = compileToFunction('<div>{{name}}</div>')\nlet oldVnode = render1.call(vm1)\n// 2.\u521b\u5efa\u7b2c\u4e8c\u4e2a\u865a\u62df\u8282\u70b9\nlet vm2 = new Vue({data:{name:'jw'}});\nlet render2 = compileToFunction('<p>{{name}}</p>');\nlet newVnode = render2.call(vm2);\n// 3.\u901a\u8fc7\u7b2c\u4e00\u4e2a\u865a\u62df\u8282\u70b9\u505a\u9996\u6b21\u6e32\u67d3\nlet el = createElm(oldVnode)\ndocument.body.appendChild(el);\n// 4.\u8c03\u7528patch\u65b9\u6cd5\u8fdb\u884c\u5bf9\u6bd4\u64cd\u4f5c\npatch(oldVnode,newVnode);\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u6211\u4eec\u60f3\u638c\u63e1vue\u4e2d\u7684diff\u7b97\u6cd5\u5c31\u5148\u6784\u5efa\u51fa\u4e24\u4e2a\u865a\u62df",(0,l.kt)("inlineCode",{parentName:"p"},"dom")," \u4e4b\u540e\u505apatch")),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"img",src:t(2214).Z,width:"3113",height:"3500"})),(0,l.kt)("h3",{id:"\u4e00\u57fa\u672cdiff\u7b97\u6cd5"},"\u4e00.\u57fa\u672cDiff\u7b97\u6cd5"),(0,l.kt)("h4",{id:"1\u6bd4\u5bf9\u6807\u7b7e"},"1.\u6bd4\u5bf9\u6807\u7b7e"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"}," // \u5982\u679c\u6807\u7b7e\u4e0d\u4e00\u81f4\u8bf4\u660e\u662f\u4e24\u4e2a\u4e0d\u540c\u5143\u7d20\n if(oldVnode.tag !== vnode.tag){\n    oldVnode.el.parentNode.replaceChild(createElm(vnode),oldVnode.el)\n }\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u5728diff\u8fc7\u7a0b\u4e2d\u4f1a\u5148\u6bd4\u8f83\u6807\u7b7e\u662f\u5426\u4e00\u81f4\uff0c\u5982\u679c\u6807\u7b7e\u4e0d\u4e00\u81f4\u7528\u65b0\u7684\u6807\u7b7e\u66ff\u6362\u6389\u8001\u7684\u6807\u7b7e")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"// \u5982\u679c\u6807\u7b7e\u4e00\u81f4\u4f46\u662f\u4e0d\u5b58\u5728\u5219\u662f\u6587\u672c\u8282\u70b9\nif(!oldVnode.tag){\n    if(oldVnode.text !== vnode.text){\n        oldVnode.el.textContent = vnode.text;\n    }\n}\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u5982\u679c\u6807\u7b7e\u4e00\u81f4\uff0c\u6709\u53ef\u80fd\u90fd\u662f\u6587\u672c\u8282\u70b9\uff0c\u90a3\u5c31\u6bd4\u8f83\u6587\u672c\u7684\u5185\u5bb9\u5373\u53ef")),(0,l.kt)("h4",{id:"2\u6bd4\u5bf9\u5c5e\u6027"},"2.\u6bd4\u5bf9\u5c5e\u6027"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"// \u590d\u7528\u6807\u7b7e,\u5e76\u4e14\u66f4\u65b0\u5c5e\u6027\nlet el = vnode.el = oldVnode.el;\nupdateProperties(vnode,oldVnode.data);\nfunction updateProperties(vnode,oldProps={}) {\n    let newProps = vnode.data || {};\n    let el = vnode.el;\n    // \u6bd4\u5bf9\u6837\u5f0f\n    let newStyle = newProps.style || {};\n    let oldStyle = oldProps.style || {};\n    for(let key in oldStyle){\n        if(!newStyle[key]){\n            el.style[key] = ''\n        }\n    }\n    // \u5220\u9664\u591a\u4f59\u5c5e\u6027\n    for(let key in oldProps){\n        if(!newProps[key]){\n            el.removeAttribute(key);\n        }\n    }\n    for (let key in newProps) {\n        if (key === 'style') {\n            for (let styleName in newProps.style) {\n                el.style[styleName] = newProps.style[styleName];\n            }\n        } else if (key === 'class') {\n            el.className = newProps.class;\n        } else {\n            el.setAttribute(key, newProps[key]);\n        }\n    }\n}\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u5f53\u6807\u7b7e\u76f8\u540c\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u590d\u7528\u8001\u7684\u6807\u7b7e\u5143\u7d20\uff0c\u5e76\u4e14\u8fdb\u884c\u5c5e\u6027\u7684\u6bd4\u5bf9\u3002")),(0,l.kt)("h4",{id:"3\u6bd4\u5bf9\u5b50\u5143\u7d20"},"3.\u6bd4\u5bf9\u5b50\u5143\u7d20"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"// \u6bd4\u8f83\u5b69\u5b50\u8282\u70b9\nlet oldChildren = oldVnode.children || [];\nlet newChildren = vnode.children || [];\n// \u65b0\u8001\u90fd\u6709\u9700\u8981\u6bd4\u5bf9\u513f\u5b50\nif(oldChildren.length > 0 && newChildren.length > 0){\n    \n// \u8001\u7684\u6709\u513f\u5b50\u65b0\u7684\u6ca1\u6709\u6e05\u7a7a\u5373\u53ef\n}else if(oldChildren.length > 0 ){\n    el.innerHTML = '';\n// \u65b0\u7684\u6709\u513f\u5b50\n}else if(newChildren.length > 0){\n    for(let i = 0 ; i < newChildren.length ;i++){\n        let child = newChildren[i];\n        el.appendChild(createElm(child));\n    }\n}\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u8fd9\u91cc\u8981\u5224\u65ad\u65b0\u8001\u8282\u70b9\u513f\u5b50\u7684\u72b6\u51b5")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"if (oldChildren.length > 0 && newChildren.length > 0) {\n    updateChildren(el, oldChildren, newChildren)\n    // \u8001\u7684\u6709\u513f\u5b50\u65b0\u7684\u6ca1\u6709\u6e05\u7a7a\u5373\u53ef\n}\n")),(0,l.kt)("h3",{id:"\u4e8cdiff\u4e2d\u7684\u4f18\u5316\u7b56\u7565"},"\u4e8c.Diff\u4e2d\u7684\u4f18\u5316\u7b56\u7565"),(0,l.kt)("h4",{id:"1\u5728\u5f00\u5934\u548c\u7ed3\u5c3e\u65b0\u589e\u5143\u7d20"},"1.\u5728\u5f00\u5934\u548c\u7ed3\u5c3e\u65b0\u589e\u5143\u7d20"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"function isSameVnode(oldVnode,newVnode){\n    // \u5982\u679c\u4e24\u4e2a\u4eba\u7684\u6807\u7b7e\u548ckey \u4e00\u6837\u6211\u8ba4\u4e3a\u662f\u540c\u4e00\u4e2a\u8282\u70b9 \u865a\u62df\u8282\u70b9\u4e00\u6837\u6211\u5c31\u53ef\u4ee5\u590d\u7528\u771f\u5b9e\u8282\u70b9\u4e86\n    return (oldVnode.tag === newVnode.tag) && (oldVnode.key === newVnode.key)\n}\nfunction updateChildren(parent, oldChildren, newChildren) {\n    let oldStartIndex = 0;\n    let oldStartVnode = oldChildren[0];\n    let oldEndIndex = oldChildren.length - 1;\n    let oldEndVnode = oldChildren[oldEndIndex];\n\n    let newStartIndex = 0;\n    let newStartVnode = newChildren[0];\n    let newEndIndex = newChildren.length - 1;\n    let newEndVnode = newChildren[newEndIndex];\n\n    while (oldStartIndex <= oldEndIndex && newStartIndex <= newEndIndex) {\n        // \u4f18\u5316\u5411\u540e\u8ffd\u52a0\u903b\u8f91\n        if(isSameVnode(oldStartVnode,newStartVnode)){\n            patch(oldStartVnode,newStartVnode);\n            oldStartVnode = oldChildren[++oldStartIndex];\n            newStartVnode = newChildren[++newStartIndex];\n        // \u4f18\u5316\u5411\u524d\u8ffd\u52a0\u903b\u8f91\n        }else if(isSameVnode(oldEndVnode,newEndVnode)){ \n            patch(oldEndVnode,newEndVnode); // \u6bd4\u8f83\u5b69\u5b50 \n            oldEndVnode = oldChildren[--oldEndIndex];\n            newEndVnode = newChildren[--newEndIndex];\n        }\n    }\n    if(newStartIndex <= newEndIndex){\n        for(let i = newStartIndex ; i<=newEndIndex ;i++){\n            let ele = newChildren[newEndIndex+1] == null? null:newChildren[newEndIndex+1].el;\n            parent.insertBefore(createElm(newChildren[i]),ele);\n        }\n    }\n}\n")),(0,l.kt)("h4",{id:"2\u5934\u79fb\u5c3e\u5c3e\u79fb\u5934"},"2.\u5934\u79fb\u5c3e\u3001\u5c3e\u79fb\u5934"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"// \u5934\u79fb\u52a8\u5230\u5c3e\u90e8\nelse if(isSameVnode(oldStartVnode,newEndVnode)){\n    patch(oldStartVnode,newEndVnode);\n    parent.insertBefore(oldStartVnode.el,oldEndVnode.el.nextSibling);\n    oldStartVnode = oldChildren[++oldStartIndex];\n    newEndVnode = newChildren[--newEndIndex]\n// \u5c3e\u90e8\u79fb\u52a8\u5230\u5934\u90e8\n}else if(isSameVnode(oldEndVnode,newStartVnode)){\n    patch(oldEndVnode,newStartVnode);\n    parent.insertBefore(oldEndVnode.el,oldStartVnode.el);\n    oldEndVnode = oldChildren[--oldEndIndex];\n    newStartVnode = newChildren[++newStartIndex]\n}\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u4ee5\u4e0a\u56db\u4e2a\u6761\u4ef6\u5bf9\u5e38\u89c1\u7684dom\u64cd\u4f5c\u8fdb\u884c\u4e86\u4f18\u5316\u3002")),(0,l.kt)("h4",{id:"3\u66b4\u529b\u6bd4\u5bf9"},"3.\u66b4\u529b\u6bd4\u5bf9"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"function makeIndexByKey(children) {\n    let map = {};\n    children.forEach((item, index) => {\n        map[item.key] = index\n    });\n    return map; \n}\nlet map = makeIndexByKey(oldChildren);\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u5bf9\u6240\u6709\u7684\u5b69\u5b50\u5143\u7d20\u8fdb\u884c\u7f16\u53f7")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"let moveIndex = map[newStartVnode.key];\nif (moveIndex == undefined) { // \u8001\u7684\u4e2d\u6ca1\u6709\u5c06\u65b0\u5143\u7d20\u63d2\u5165\n    parent.insertBefore(createElm(newStartVnode), oldStartVnode.el);\n} else { // \u6709\u7684\u8bdd\u505a\u79fb\u52a8\u64cd\u4f5c\n    let moveVnode = oldChildren[moveIndex]; \n    oldChildren[moveIndex] = undefined;\n    parent.insertBefore(moveVnode.el, oldStartVnode.el);\n    patch(moveVnode, newStartVnode);\n}\nnewStartVnode = newChildren[++newStartIndex]\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u7528\u65b0\u7684\u5143\u7d20\u53bb\u8001\u7684\u4e2d\u8fdb\u884c\u67e5\u627e\uff0c\u5982\u679c\u627e\u5230\u5219\u79fb\u52a8\uff0c\u627e\u4e0d\u5230\u5219\u76f4\u63a5\u63d2\u5165")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"if(oldStartIndex <= oldEndIndex){\n    for(let i = oldStartIndex; i<=oldEndIndex;i++){\n        let child = oldChildren[i];\n        if(child != undefined){\n            parent.removeChild(child.el)\n        }\n    }\n}\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u5982\u679c\u6709\u5269\u4f59\u5219\u76f4\u63a5\u5220\u9664")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"if(!oldStartVnode){\n    oldStartVnode = oldChildren[++oldStartIndex];\n}else if(!oldEndVnode){\n    oldEndVnode = oldChildren[--oldEndIndex]\n}\n")),(0,l.kt)("p",null,"\u5728\u6bd4\u5bf9\u8fc7\u7a0b\u4e2d\uff0c\u53ef\u80fd\u51fa\u73b0\u7a7a\u503c\u60c5\u51b5\u5219\u76f4\u63a5\u8df3\u8fc7"),(0,l.kt)("h3",{id:"\u4e09\u66f4\u65b0\u64cd\u4f5c"},"\u4e09.\u66f4\u65b0\u64cd\u4f5c"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"Vue.prototype._update = function (vnode) {\n    const vm  = this;\n    const prevVnode = vm._vnode; // \u4fdd\u7559\u4e0a\u4e00\u6b21\u7684vnode\n    vm._vnode = vnode;\n    if(!prevVnode){\n        vm.$el = patch(vm.$el,vnode); // \u9700\u8981\u7528\u865a\u62df\u8282\u70b9\u521b\u5efa\u51fa\u771f\u5b9e\u8282\u70b9 \u66ff\u6362\u6389 \u771f\u5b9e\u7684$el\n        // \u6211\u8981\u901a\u8fc7\u865a\u62df\u8282\u70b9 \u6e32\u67d3\u51fa\u771f\u5b9e\u7684dom     \n    }else{\n        vm.$el = patch(prevVnode,vnode); // \u66f4\u65b0\u65f6\u505adiff\u64cd\u4f5c\n    }\n}\n")))}u.isMDXComponent=!0},9850:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/1-6cf23a6f47c019f57dc8eebfe6ff4208.png"},2214:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/vue-diff.4c21677d-fb2b924034811ae9f9a244af5695c015.jpg"}}]);