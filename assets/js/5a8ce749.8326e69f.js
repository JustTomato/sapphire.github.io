"use strict";(self.webpackChunksapphire=self.webpackChunksapphire||[]).push([[303],{3905:(e,n,r)=>{r.d(n,{Zo:()=>p,kt:()=>f});var t=r(7294);function o(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function l(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,t)}return r}function a(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?l(Object(r),!0).forEach((function(n){o(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function s(e,n){if(null==e)return{};var r,t,o=function(e,n){if(null==e)return{};var r,t,o={},l=Object.keys(e);for(t=0;t<l.length;t++)r=l[t],n.indexOf(r)>=0||(o[r]=e[r]);return o}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(t=0;t<l.length;t++)r=l[t],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}var i=t.createContext({}),c=function(e){var n=t.useContext(i),r=n;return e&&(r="function"==typeof e?e(n):a(a({},n),e)),r},p=function(e){var n=c(e.components);return t.createElement(i.Provider,{value:n},e.children)},m="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},d=t.forwardRef((function(e,n){var r=e.components,o=e.mdxType,l=e.originalType,i=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),m=c(r),d=o,f=m["".concat(i,".").concat(d)]||m[d]||u[d]||l;return r?t.createElement(f,a(a({ref:n},p),{},{components:r})):t.createElement(f,a({ref:n},p))}));function f(e,n){var r=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var l=r.length,a=new Array(l);a[0]=d;var s={};for(var i in n)hasOwnProperty.call(n,i)&&(s[i]=n[i]);s.originalType=e,s[m]="string"==typeof e?e:o,a[1]=s;for(var c=2;c<l;c++)a[c]=r[c];return t.createElement.apply(null,a)}return t.createElement.apply(null,r)}d.displayName="MDXCreateElement"},6307:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>i,contentTitle:()=>a,default:()=>u,frontMatter:()=>l,metadata:()=>s,toc:()=>c});var t=r(7462),o=(r(7294),r(3905));const l={},a=void 0,s={unversionedId:"javascript/Promise",id:"javascript/Promise",title:"Promise",description:"0.\u5173\u4e8ePromise",source:"@site/docs/javascript/Promise.md",sourceDirName:"javascript",slug:"/javascript/Promise",permalink:"/sapphire.github.io/docs/javascript/Promise",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"\u9ad8\u9636\u51fd\u6570",permalink:"/sapphire.github.io/docs/javascript/Function"},next:{title:"\u751f\u6210\u5668\uff08Generator\uff09",permalink:"/sapphire.github.io/docs/javascript/Generator"}},i={},c=[{value:"0.\u5173\u4e8ePromise",id:"0\u5173\u4e8epromise",level:3},{value:"1.\u7528\u6cd5",id:"1\u7528\u6cd5",level:3},{value:"2.\u603b\u7ed3\u7279\u6027",id:"2\u603b\u7ed3\u7279\u6027",level:3},{value:"1.<code>Promise</code>\u94fe\u5f0f\u8c03\u7528\u95ee\u9898",id:"1promise\u94fe\u5f0f\u8c03\u7528\u95ee\u9898",level:4},{value:"2.Promise.resolve/reject",id:"2promiseresolvereject",level:4},{value:"3.Promise.all",id:"3promiseall",level:4},{value:"4.Promise.finally",id:"4promisefinally",level:4},{value:"5.Promise.race",id:"5promiserace",level:4},{value:"6.Promise.abort",id:"6promiseabort",level:4},{value:"7.Promisify\u65b9\u6cd5",id:"7promisify\u65b9\u6cd5",level:4},{value:"8.promisifyAll\u65b9\u6cd5",id:"8promisifyall\u65b9\u6cd5",level:4},{value:"9.Promise.allSettled()",id:"9promiseallsettled",level:4},{value:"3.\u624b\u5199Promise",id:"3\u624b\u5199promise",level:3},{value:"<code>promises-aplus-tests</code>",id:"promises-aplus-tests",level:4},{value:"1.\u5b89\u88c5",id:"1\u5b89\u88c5",level:5},{value:"2.\u6d4b\u8bd5",id:"2\u6d4b\u8bd5",level:5},{value:"\u7ec3\u4e60\u9898",id:"\u7ec3\u4e60\u9898",level:4}],p={toc:c},m="wrapper";function u(e){let{components:n,...r}=e;return(0,o.kt)(m,(0,t.Z)({},p,r,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h3",{id:"0\u5173\u4e8epromise"},"0.\u5173\u4e8ePromise"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"1.\u5f02\u6b65\u5e76\u53d1\u95ee\u9898\u3010Promise.all\u3011\n2.\u89e3\u51b3\u56de\u8c03\u5730\u72f1\u95ee\u9898\u5373\u4e0a\u4e00\u4e2a\u51fd\u6570\u7684\u8f93\u51fa\u662f\u4e0b\u4e00\u4e2a\u51fd\u6570\u7684\u8f93\u5165\u3010\u94fe\u5f0f\u64cd\u4f5c\uff1athen\u3011\n3.\u9519\u8bef\u5904\u7406\u65b9\u6cd5\u975e\u5e38\u65b9\u4fbf\u3010catch\u65b9\u6cd5\u3011\n\u4f46\u662fPromise\u5b58\u5728\u7684\u7f3a\u9677\uff1a\u5b83\u4f9d\u65e7\u662f\u57fa\u4e8e\u56de\u8c03\u51fd\u6570\n")),(0,o.kt)("h3",{id:"1\u7528\u6cd5"},"1.\u7528\u6cd5"),(0,o.kt)("p",null,"1.",(0,o.kt)("inlineCode",{parentName:"p"},"Promise"),"\u662f\u4e00\u4e2a\u7c7b\uff0c\u7c7b\u4e2d\u7684\u6784\u9020\u51fd\u6570\u9700\u8981\u4f20\u5165\u4e00\u4e2a",(0,o.kt)("inlineCode",{parentName:"p"},"executor"),"\u53c2\u6570\uff0c",(0,o.kt)("inlineCode",{parentName:"p"},"executor"),"\u9ed8\u8ba4\u5c31\u4f1a\u6267\u884c"),(0,o.kt)("p",null,"2.",(0,o.kt)("inlineCode",{parentName:"p"},"executor"),"\u4e2d\u6709\u4e24\u4e2a\u53c2\u6570 \u5206\u522b\u662f",(0,o.kt)("inlineCode",{parentName:"p"},"resolve"),"\uff0c",(0,o.kt)("inlineCode",{parentName:"p"},"reject")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"let p = new Promise((resolve, reject) => {\n  console.log(1)\n});\nconsole.log(2); //\u7531\u4e8eexecutor\u53c2\u6570\u4f1a\u7acb\u5373\u6267\u884c\uff0c\u6240\u4ee5\u6253\u5370\u51fa\u6765\u7684\u987a\u5e8f\u662f1 2\n")),(0,o.kt)("p",null,"3.\u521b\u5efa\u4e00\u4e2a",(0,o.kt)("inlineCode",{parentName:"p"},"Promise"),"\u9ed8\u8ba4\u72b6\u6001\u5c31\u662f",(0,o.kt)("inlineCode",{parentName:"p"},"pending")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"let p = new Promise((resolve, reject) => {\n});\nconsole.log(p) //Promise\xa0{<pending>}\n")),(0,o.kt)("p",null,"4.",(0,o.kt)("inlineCode",{parentName:"p"},"Promise"),"\u6709\u4e09\u4e2a\u72b6\u6001\u5206\u522b\u662f",(0,o.kt)("inlineCode",{parentName:"p"},"pending"),"\uff08\u7b49\u5f85\uff09\u3001",(0,o.kt)("inlineCode",{parentName:"p"},"fulfilled "),"\uff08\u6210\u529f\uff09\u3001",(0,o.kt)("inlineCode",{parentName:"p"},"rejected")," \uff08\u5931\u8d25\uff09"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"fulfilled ")," ==> ",(0,o.kt)("inlineCode",{parentName:"li"},"resolve()")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"rejected")," ==>",(0,o.kt)("inlineCode",{parentName:"li"}," reject()"))),(0,o.kt)("p",null,"5.\u8c03\u7528\u6210\u529f\u548c\u5931\u8d25\u65f6\u9700\u8981\u4f20\u9012\u4e00\u4e2a\u6210\u529f\u7684\u539f\u56e0\u548c\u5931\u8d25\u7684\u539f\u56e0\n6.\u5982\u679c\u5df2\u7ecf\u6210\u529f\u4e86\u5c31\u4e0d\u80fd\u5931\u8d25\u4e86\uff08\u5373\u8c03\u7528\u4e86",(0,o.kt)("inlineCode",{parentName:"p"},"resolve"),"\u4e4b\u540e\u5c31\u4e0d\u80fd\u518d\u8c03",(0,o.kt)("inlineCode",{parentName:"p"},"reject"),"\uff0c\u53cd\u4e4b\u4ea6\u7136\uff09"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"let p = new Promise((resolve, reject) => {\n  resolve('success');\n  reject('fail')//\u4e0d\u6267\u884c\n});\np.then(res => {\n    console.log(res) //success\n},err => {\n    console.log(err)\n})\n")),(0,o.kt)("p",null,"7.\u5982\u679c\u629b\u51fa\u5f02\u5e38\u6309\u7167\u5931\u8d25\u6765\u5904\u7406\u5373\u8d70\u4e0b\u4e00\u4e2athen\u4e2d\u7684\u5931\u8d25"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"let p = new Promise((resolve, reject) => {\n   throw new Error('fail')\n});\np.then((data) => {\n    console.log('success', data)\n}, (reason) => {\n    console.log('fail', reason) //fail\n})\n")),(0,o.kt)("h3",{id:"2\u603b\u7ed3\u7279\u6027"},"2.\u603b\u7ed3\u7279\u6027"),(0,o.kt)("h4",{id:"1promise\u94fe\u5f0f\u8c03\u7528\u95ee\u9898"},"1.",(0,o.kt)("inlineCode",{parentName:"h4"},"Promise"),"\u94fe\u5f0f\u8c03\u7528\u95ee\u9898"),(0,o.kt)("p",null,"1.\u5982\u679cthen\u65b9\u6cd5\u4e2d\uff08\u6210\u529f\u6216\u8005\u5931\u8d25\uff09\u8fd4\u56de\u7684\u4e0d\u662f\u4e00\u4e2aPromise\u5b9e\u4f8b\uff0c\u5219\u4f1a\u5c06\u8fd9\u4e2a\u503c\u4f20\u9012\u7ed9\u5916\u5c42\u4e0b\u4e00\u6b21then\u7684\u6210\u529f\u7ed3\u679c\uff1b"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"//\u6ce8\u89e3\uff1a\u6b64\u5904\u7684read\u51fd\u6570\u6267\u884c\u6210\u529f\u65f6\uff0c\u5219\u8d70then\u4e2d\u7684resolve\u51fd\u6570\u5373\u8fd4\u56dereturn 100 \u5219\u4e0b\u4e00\u4e2athen\u4f1a\u6267\u884cresolve\uff0c\u5e76\u4e14\u5176\u4e2d\u7684\u503c\u65f6100\uff0c\n//\u5982\u679cread\u51fd\u6570\u7684\u6267\u884c\u6210\u679c\u662f\u5931\u8d25\u7684\u4f46\u662f\u6211\u4eec\u6b64\u5904\u53c8\u6ca1\u5199return\uff0c\u4f46\u662f\u56e0\u4e3a\u51fd\u6570\u6267\u884c\u9ed8\u8ba4\u4f1a\u8fd4\u56dereturn undefined \u6240\u4ee5\u4e0b\u4e00\u4e2athen\u4f1a\u6267\u884cresolve\uff0c\u5e76\u4e14\u5176\u4e2d\u7684\u503c\u65f6undefined\nconst fs = require('fs');\nfunction read(...args) {\n  return new Promise((resolve, reject) => {\n    fs.readFile(...args, function(err, data) {\n      if (err) return reject(err);\n      resolve(data);\n    })\n});\nread('./name.txt','utf8').then(data => {\n   return 100\n},err=>{\n  console.log(err)\n}).then((data)=>{\n    console.log(data) // 100\n},err=>{\n})\n")),(0,o.kt)("p",null,"2.\u5982\u679c\u6267\u884cthen\u65b9\u6cd5\u4e2d\u7684\u65b9\u6cd5\u51fa\u9519\u4e86\u5373\u629b\u51fa\u5f02\u5e38\u5219\u4f1a\u8d70\u5230\u4e0b\u4e00\u4e2athen\u7684\u5931\u8d25\uff1b"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"const fs = require('fs');\nfunction read(...args) {\n  return new Promise((resolve, reject) => {\n    fs.readFile(...args, function(err, data) {\n      if (err) return reject(err);\n      resolve(data);\n    })\n});\nread('./name.txt','utf8').then(data => {\n   throw new Error('err')\n},err=>{\n  console.log(err)\n}).then((data)=>{\n    console.log(data)\n},(err) => {\n   console.log(err) // err\n})\n")),(0,o.kt)("p",null,"3.\u5982\u679c\u8fd4\u56de\u7684\u662f\u4e00\u4e2aPromise\u5b9e\u4f8b\u5219\u4f1a\u7528\u8fd9\u4e2aPromise\u5b9e\u4f8b\u7684\u7ed3\u679c\u4f5c\u4e3a\u4e0b\u4e00\u6b21then\u7684\u6210\u529f\u6216\u8005\u5931\u8d25\u3002\u8be5Promise\u6210\u529f\u5219\u8d70\u4e0b\u4e00\u4e2athen\u7684\u6210\u529f\uff0c\u53cd\u4e4b\u5219\u8d70\u5931\u8d25"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"const fs = require('fs');\nfunction read(...args) {\n  return new Promise((resolve, reject) => {\n    fs.readFile(...args, function(err, data) {\n      if (err) return reject(err);\n      resolve(data);\n    })\n});\nread('./name.txt','utf8').then(data => {\n   return read(data,'utf8')\n},err=>{\n  console.log(err)\n}).then((data)=>{\n    console.log(data)\n},(err) => {\n   console.log(err) \n})\n")),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u603b\u7ed3\uff1a\u4ec0\u4e48\u60c5\u51b5\u4e0b\u4f1a\u8d70\u7b2c\u4e8c\u4e2athen\u4e2d\u7684\u5931\u8d25"),(0,o.kt)("p",{parentName:"blockquote"},"1.\u7b2c\u4e00\u4e2athen\u4e2d\u51fa\u9519\u4f1a\u8d70\u7b2c\u4e8c\u4e2athen\u7684\u5931\u8d25 "),(0,o.kt)("p",{parentName:"blockquote"},"2.\u7b2c\u4e00\u4e2athen\u4e2d\u8fd4\u56de\u7684Promise\u5b9e\u4f8b\u7684\u7ed3\u679c\u662f\u5931\u8d25\u7684\u5c31\u4f1a\u8d70\u7b2c\u4e8c\u4e2athen\u7684\u5931\u8d25")),(0,o.kt)("p",null,"4.Promise\u7684then\u65b9\u6cd5\u4e3a\u4ec0\u4e48\u53ef\u4ee5\u94fe\u5f0f\u8c03\u7528\uff1f\u56e0\u4e3a\u6bcf\u6b21\u8c03\u7528then\u65b9\u6cd5\u90fd\u8fd4\u56de\u4e86\u4e00\u4e2a\u65b0\u7684Promise\u5b9e\u4f8b\uff1b"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function read(...args) {\n  return new Promise((resolve, reject) => {\n    fs.readFile(...args, function(err, data) {\n      if (err) return reject(err);\n      resolve(data);\n    })\n});\nread('./name11111.txt','utf8').then().then().then();\n")),(0,o.kt)("p",null,"5.catch\u5c31\u662f\u4e00\u4e2a\u6ca1\u6709\u6210\u529f\u53ea\u6709\u5931\u8d25then\u65b9\u6cd5\u7684\u522b\u540d \uff08\u627e\u6700\u8fd1\u7684\u4f18\u5148\u5904\u7406\uff0c\u5904\u7406\u4e0d\u4e86\u627e\u4e0b\u4e00\u5c42\uff09\uff1b"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"const fs = require('fs');\nfunction read(...args) {\n  return new Promise((resolve, reject) => {\n    fs.readFile(...args, function(err, data) {\n      if (err) return reject(err);\n      resolve(data);\n    })\n});\nread('./name11111.txt','utf8').then(data => {\n   return read(data,'utf8')\n},err=>{\n  console.log(err)\n}).then((data)=>{\n    console.log('s:'+data) //'s:undefined'\n//\u56e0\u4e3a\u7b2c\u4e00\u4e2aread\u65b9\u6cd5\u8bfb\u53d6name1111\u6587\u4ef6\u65f6\u5931\u8d25\u4e86\uff0c\u6240\u4ee5\u8d70\u4e86\u7b2c\u4e00then\u4e2d\u7684\u5931\u8d25\uff0c\u7b2c\u4e00\u4e2athen\u4e2d\u7684\u5931\u8d25\u6ca1\u6709\u8fd4\u56de\u5176\u4ed6\u7684\uff08\u5373\u8fd4\u56de\u4e86 return undefined \u5c31\u4f1a\u5bfc\u81f4\u8d70\u4e86\u7b2c\u4e8c\u4e2athen\u4e2d\u7684\u6210\u529f\u65b9\u6cd5\uff0c\u6240\u4ee5\u6253\u5370\u51fa\u6765\u7684\u662f's:undefined'\uff09\n},(err) => {\n   console.log('f:'+err) \n}).catch(err => {\n  console.log('catch:'+err);\n})\n")),(0,o.kt)("p",null,"6.\u5982\u679c\u7b2c\u4e00\u4e2aPromise\u7684then\u4e2d\u6ca1\u6709\u4f20\u5165reject\u51fd\u6570\uff0c\u5219\u4f1a\u987a\u5ef6\u5230\u4e0b\u4e00\u4e2athen\u4e2d\u7684reject\u51fd\u6570\u4e2d\uff0c\u5982\u679c\u4e0b\u4e00\u4e2athen\u4e2d\u6ca1\u6709\uff0c\u5219\u4f9d\u6b21\u7c7b\u63a8\uff0c\u987a\u5ef6\u81f3catch\u65b9\u6cd5\uff1b"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"read('./name11111.txt','utf8').then(data => {\n   return read(data,'utf8')\n}).then((data)=>{\n    console.log('s:'+data) \n},(err) => {\n   console.log('f:'+err) //\u5728\u8fd9\u91cc\u6253\u5370\n}).catch(err => {\n  console.log('catch:'+err);\n})\n//\u6216\u8005\nread('./name11111.txt','utf8').then(data => {\n   return read(data,'utf8')\n}).then((data)=>{\n    console.log('s:'+data) \n}).catch(err => {\n  console.log('catch:'+err); //\u5728\u8fd9\u91cc\u6253\u5370\n})\n")),(0,o.kt)("p",null,"7.\u5982\u679ccatch\u4e2d\u4e5f\u6ca1\u6709\u8fd4\u56de\u503c\uff08\u5373 return undefined\uff09,\u5219\u4f1a\u8d70\u5230\u4e0b\u4e00\u4e2athen\u4e2d\u7684resolve\u65b9\u6cd5"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"read('./name11111.txt','utf8').then(data => {\n   return read(data,'utf8')\n}).then((data)=>{\n    console.log('s:'+data) \n}).catch(err => {\n  console.log('catch:'+err); \n}).then(data => {\n  console.log(data) //\u5728\u8fd9\u91cc\u6253\u5370 undefined\n})\n  \n//\u603b\u7ed3\uff1acatch\u76f8\u5f53\u4e8e\u4e00\u4e2a\u53ea\u4f20\u4e86reject\u7684then\n.then(null, err => {\n  console.log(data)\n})\n")),(0,o.kt)("h4",{id:"2promiseresolvereject"},"2.Promise.resolve/reject"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"Promise.resolve('123').then((data) => {\n  console.log(data) // 123\n})\n//\u5982\u679cPromise.resolve()\u653e\u7684\u662f\u4e00\u4e2aPromise\u5b9e\u4f8b\uff0c\u5219\u4f1a\u6839\u636e\u8fd9\u4e2apromise\u6210\u529f\u6216\u8005\u5931\u8d25\u8d70\u4e0b\u4e00\u4e2athen\u65b9\u6cd5\n//\u5982\u679cPromise.catch()\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"//catch\u5c31\u662f\u6ca1\u6709\u4f20\u6210\u529f\u53c2\u6570\u7684then\u65b9\u6cd5 ==> then(null,err => {})\nPromise.reject('123').catch((data) => {\n  console.log(data) //123\n})\n//\u5982\u679cPromise.reject()\u653e\u7684\u662f\u4e00\u4e2aPromise\u5b9e\u4f8b\uff0c\u4e0d\u4f1a\u770b\u8fd9\u4e2apromise\u5b9e\u4f8b\u7684\u7ed3\u679c\uff0c\u800c\u662f\u76f4\u63a5\u8d70then\u65b9\u6cd5\u4e2d\u7684\u5931\u8d25\n")),(0,o.kt)("h4",{id:"3promiseall"},"3.Promise.all"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"1.Promise.all\u65b9\u6cd5\u8fd4\u56de\u7684\u4e5f\u662f\u4e00\u4e2apromise"),(0,o.kt)("p",{parentName:"blockquote"},"2.Promise.all\u53c2\u6570\u662f\u4e00\u4e2a\u6570\u7ec4\uff0c\u5982\u679c\u6570\u7ec4\u4e2d\u67d0\u4e00\u9879\u662f\u666e\u901a\u503c\uff0c\u5219\u76f4\u63a5\u653e\u8fdb\u7ed3\u679c\u7684\u6570\u7ec4\u91cc\u3002\u53cd\u4e4b\u5219\u7b49\u5f85promise\u7684\u6210\u529f\u4e0e\u5931\u8d25"),(0,o.kt)("p",{parentName:"blockquote"},"3.Promise.all\u4e2d\u53ea\u8981\u6709\u4e00\u4e2apromise\u5931\u8d25\u3002\u5219\u5168\u4f53\u5931\u8d25")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"const Promise = require(\"./promise.js\")\nlet fs = require('fs').promises\nlet getName =  fs.readFile('./name.txt','utf8')\nlet getAge =  fs.readFile('./age.txt','utf8')\n// Promise.all\u65b9\u6cd5\u8fd4\u56de\u7684\u662f\u4e00\u4e2apromise,\u5176\u4e2d\u4e00\u4e2a\u5931\u8d25\u5c31\u5168\u90e8\u5931\u8d25\u4e86\nPromise.all([1,getName,getAge,2]).then(data=>{ // \n    console.log(data);[1,Tomato,22,2]\n    //\u8fd9\u91cc\u7684data\u4e5f\u662f\u4e00\u4e2a\u6570\u7ec4\uff0c\u5206\u522b\u6309\u987a\u5e8f\u5b58\u653e1 \u3001getName\u7684promise\u7684then\u65b9\u6cd5\u4e4b\u540e\u8fd4\u56de\u7684\u503c \u3001 getAge\u7684promise\u7684then\u65b9\u6cd5\u4e4b\u540e\u8fd4\u56de\u7684\u503c \u548c 2\n});\n")),(0,o.kt)("h4",{id:"4promisefinally"},"4.Promise.finally"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"1.finally\u65b9\u6cd5\u6ca1\u6709\u5165\u53c2;"),(0,o.kt)("p",{parentName:"blockquote"},"2.finally\u65b9\u6cd5\u91cc\u9762\u7684\u4ee3\u7801\u65e0\u8bba\u5982\u4f55\u90fd\u4f1a\u6267\u884c;"),(0,o.kt)("p",{parentName:"blockquote"},"3.finally\u65b9\u6cd5\u540e\u9762\u8fd8\u53ef\u4ee5\u4f7f\u7528then\u65b9\u6cd5\uff0c\u56e0\u4e3afinally\u4e5f\u662f\u8fd4\u56de\u4e00\u4e2apromise ;")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"Promise.resolve(123).finally((data) => {\n  console.log('finally',data); // finally undefined\n}).then(data => {\n  console.log(data) // 123\n})\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"Promise.reject(123).finally((data) => {\n  console.log('finally',data); // finally undefined\n}).then(data => {\n  console.log(data)\n},err => {\n  console.log('err',err) //err 123\n})\n//\u5f53\u4e00\u4e2aPromise\u5931\u8d25\u4e86\u5c31\u4f1a\u8d70\u4e0b\u4e00\u4e2athen\u7684\u5931\u8d25\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"Promise.resolve(123).finally((data) => {\n  console.log('finally'); //finally\n  return new Promise((resolve,reject) => {\n    setTimeout(() => {\n      resolve('ok')\n    }, 5000);\n  })\n}).then(data => {\n  console.log(data) //123\uff08\u7b49\u5f855000\u6beb\u79d2\u4e4b\u540e\u624d\u4f1a\u6253\u5370\uff09\u5f53\u4e00\u4e2apromise\u6210\u529f\u4e86\u4f1a\u8d70\u4e0b\u4e00\u4e2athen\u4e2d\u7684\u6210\u529f\uff08\u4f1a\u7b49\u5e26\u91cc\u9762\u6267\u884c\u5b8c\u6bd5\uff09\n})\n//\u4e0d\u8bbafinally\u65b9\u6cd5\u91cc\u9762\u8fd4\u56de\u7684\u662f\u4ec0\u4e48\uff0c\u662fpromise\u5b9e\u4f8b\u8fd8\u662f\u5176\u4ed6\uff0c\u90fd\u4e0d\u5f71\u54cd\u540e\u9762then\u7684\u7ed3\u679c\u3002\u53ea\u770bfinally\u65b9\u6cd5\u524d\u9762\u7684\n\n//\u4e00\u4e2a\u6210\u529f\u7684promise\u7b49\u5f85\u53e6\u4e00\u4e2apromise\u5931\u8d25\uff0c\u5219\u4f1a\u8d70\u5230\u4e0b\u4e00\u4e2athen\u65b9\u6cd5\u7684\u5931\u8d25\nPromise.reject(123).finally((data) => {\n  console.log('finally'); //finally\n  return new Promise((resolve,reject) => {\n    setTimeout(() => {\n      reject('ok')\n    }, 5000);\n  })\n}).then(data => {\n  console.log(data) \n},err => {\n  console.log('err',err) //err ok\n})\n\n//2\nPromise.resolve(123).finally((data) => {\n  console.log('finally'); //finally\n  return new Promise((resolve,reject) => {\n    setTimeout(() => {\n      reject('ok')\n    }, 5000);\n  })\n}).then(data => {\n  console.log(data) \n},err => {\n  console.log('err',err) //err ok\n})\n")),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u603b\u7ed3\uff1a",(0,o.kt)("inlineCode",{parentName:"p"},"Promise.all"),"\u8ddf",(0,o.kt)("inlineCode",{parentName:"p"},"Promise.finally"),"\u7684\u4f7f\u7528\u573a\u666f"),(0,o.kt)("p",{parentName:"blockquote"},"all\u4f7f\u7528\u4e8e\u5e76\u53d1\u591a\u4e2a\u8bf7\u6c42\u800cfinally\u662f\u65e0\u8bba\u8bf7\u6c42\u6216\u8005\u5176\u4ed6\u64cd\u4f5c\u7ed3\u679c\u600e\u4e48\u6837\uff0c\u6211\u90fd\u8981\u5728finally\u65b9\u6cd5\u91cc\u9762\u5904\u7406\u4e00\u4e9b\u903b\u8f91")),(0,o.kt)("h4",{id:"5promiserace"},"5.Promise.race"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("inlineCode",{parentName:"p"},"Promise.all")," ",(0,o.kt)("inlineCode",{parentName:"p"},"Promise.race")," ",(0,o.kt)("inlineCode",{parentName:"p"},"Promise.allSettled"),"\u4e09\u8005\u7684\u533a\u522b"),(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("inlineCode",{parentName:"p"},"Promise.all"),"\uff1a\u4e00\u4e2a\u5931\u8d25\u5c31\u5168\u5931\u8d25"),(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("inlineCode",{parentName:"p"},"Promise.race"),"\uff1a\u8d5b\u8dd1\u6a21\u5f0f\uff0c\u91c7\u7528\u8dd1\u5f97\u6700\u5feb\u7684\u90a3\u4e2a\u4f5c\u4e3a\u7ed3\u679c"),(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("inlineCode",{parentName:"p"},"Promise.allSettled"),"\uff1a\u65e2\u8981\u6210\u529f\u4e5f\u8981\u5931\u8d25 \u8ddf",(0,o.kt)("inlineCode",{parentName:"p"},"Promise.finally"),"\u633a\u50cf \u3010Promise\u5df2\u7ecf\u6709\u8fd9\u4e2a\u65b9\u6cd5\u4e86\u3011")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"Promise.race")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"let p1 = new Promise((resolve,reject) => {\n  setTimeout(()=>{\n    resolve('ok')\n  },1000)\n})\n\nlet p2 = new Promise((resolve,reject) => {\n  setTimeout(()=>{\n    reject('no ok')\n  },2000)\n})\n\nPromise.race([p1,p2]).then((values) => {\n  console.log(values) // ok\n})\n//\u5b58\u5728\u666e\u901a\u503c\nPromise.race([p1,p2,1]).then((values) => {\n  console.log(values) // 1\n})\n")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"Promise.allSettled")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"let p1 = new Promise((resolve,reject) => {\n  setTimeout(()=>{\n    resolve('ok')\n  },1000)\n})\n\nlet p2 = new Promise((resolve,reject) => {\n  setTimeout(()=>{\n    reject('no ok')\n  },1000)\n})\n\nPromise.allSettled([p1,p2]).then((values) => {\n  console.log(values)\n  // [\n  //   { status: 'fulfilled', value: 'ok' },\n  //   { status: 'rejected', reason: 'no ok' }\n  // ]\n})\n")),(0,o.kt)("h4",{id:"6promiseabort"},"6.Promise.abort"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u539f\u751f\u7684Promise\u4e2d\u6ca1\u6709abort\u65b9\u6cd5\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u662f\u6211\u4eec\u81ea\u5df1\u57fa\u4e8ePromise\u5c01\u88c5\u7684;"),(0,o.kt)("p",{parentName:"blockquote"},"abort\u65b9\u6cd5\u5c31\u662f\u4e0d\u8981promise\u8fd9\u6b21\u6210\u529f\u7684\u7ed3\u679c")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"let p1 = new Promise((resolve,reject) => {\n  setTimeout(()=>{\n    resolve('success')\n  },3000)\n})\nfunction warp(p1){\n  let abort;\n  let p2 = new Promise((resolve,reject) => {\n    abort = reject;\n  })\n  let newPromise = Promise.race([p1,p2])\n  newPromise.abort = abort;\n  return newPromise;\n}\nlet p2 = warp(p1);\np2.then(data => {\n  console.log(data)\n}).catch(err => {\n  console.log(err) // 1s abort\n})\nsetTimeout(()=>{\n  p2.abort('1s abort')\n},1000)\n")),(0,o.kt)("h4",{id:"7promisify\u65b9\u6cd5"},"7.Promisify\u65b9\u6cd5"),(0,o.kt)("p",null,"\u5728node\u4e2dfs\u6a21\u5757\u4e2d\u7684promises"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"const fs  = require('fs').promises;\nfs.readFile('note.txt','utf-8').then((data) => {\n  console.log(data) //note.txt\u7684\u5185\u5bb9\n})\n")),(0,o.kt)("p",null,"\u5b9e\u73b0\u81ea\u5df1\u7684promises\u65b9\u6cd5"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"const fs  = require('fs');\nfunction promisify(fn){\n  //\u9ad8\u9636\u51fd\u6570\n  return function(...args){\n    return new Promise((resolve,reject) => {\n      fn(...args,function(err,data){\n        if(err) reject(err);\n        resolve(data);\n      })\n    })\n  }\n}\n\nconst readFile = promisify(fs.readFile);\nreadFile('note.txt','utf-8').then(data => {\n  console.log(data) //note.txt\u7684\u5185\u5bb9\n})\n")),(0,o.kt)("h4",{id:"8promisifyall\u65b9\u6cd5"},"8.promisifyAll\u65b9\u6cd5"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("inlineCode",{parentName:"p"},"promisifyAll"),"\u529f\u80fd\u7c7b\u4f3c\u4e8e",(0,o.kt)("inlineCode",{parentName:"p"},"bluebird"),"\u63d2\u4ef6\uff0c\u4f46\u662f\u6211\u4eec\u5b8c\u5168\u53ef\u4ee5\u57fa\u4e8epromise\u6765\u5b9e\u73b0\u8fd9\u4e2a\u529f\u80fd")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"const fs = require('fs');\nfunction promisify(fn){\n  return (...args) => {\n    return new Promise((resolve,reject) => {\n      fn(...args,(err,data) => {\n        if(err) return reject(err);\n        resolve(data);\n      })\n    })\n  }\n}\nfunction promisifyAll(target){\n  Reflect.ownKeys(target).forEach(key => {\n    target[key + 'Async'] = promisify(target[key])\n  })\n  return target;\n}\nlet obj = promisifyAll(fs);\nobj.readFileAsync('age.txt','utf8').then(data => {\n  console.log(data);\n})\n")),(0,o.kt)("p",null,"\u4f46\u662f\u5728node\u4e2d\u6709\u5185\u7f6e\u6a21\u5757util\u63d0\u4f9b\u8fd9\u6837\u7684API\u4e86"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"const fs = require('fs');\nconst util = require('util'); //node\u7684\u5185\u7f6e\u6a21\u5757\n\nfunction promisifyAll(target){\n  Reflect.ownKeys(target).forEach(key => {\n      if(typeof target[key] === 'function'){\n         target[key + 'Async'] = util.promisify(target[key])\n      }\n  })\n  return target;\n} \nlet obj = promisifyAll(fs);\nobj.readFileAsync('age.txt','utf8').then(data => {\n  console.log(data);\n})\n")),(0,o.kt)("h4",{id:"9promiseallsettled"},"9.Promise.allSettled()"),(0,o.kt)("p",null,"\u8be5",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"Promise.allSettled()")),"\u65b9\u6cd5\u8fd4\u56de\u4e00\u4e2a\u5728\u6240\u6709\u7ed9\u5b9a\u7684 promise \u90fd\u5df2\u7ecf",(0,o.kt)("inlineCode",{parentName:"p"},"fulfilled"),"\u6216",(0,o.kt)("inlineCode",{parentName:"p"},"rejected"),"\u540e\u7684 promise\uff0c\u5e76\u5e26\u6709\u4e00\u4e2a\u5bf9\u8c61\u6570\u7ec4\uff0c\u6bcf\u4e2a\u5bf9\u8c61\u8868\u793a\u5bf9\u5e94\u7684 promise \u7ed3\u679c\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-JS"},'const promise1 = Promise.resolve(3);\nconst promise2 = new Promise((resolve, reject) => setTimeout(reject, 100, \'foo\'));\nconst promises = [promise1, promise2];\n\nPromise.allSettled(promises).\n  then((results) => results.forEach((result) => console.log(result.status)));\n\n// expected output:\n// "fulfilled"\n// "rejected"\n')),(0,o.kt)("h3",{id:"3\u624b\u5199promise"},"3.\u624b\u5199Promise"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"const STATUS = {\n    PENDING: 'PENDING',\n    FULFILLED: 'FULFILLED',\n    REJECTED: 'REJECTED'\n}\nfunction resolvePromise(x, promise2, resolve, reject) {\n    if (x === promise2) {\n        throw TypeError('type error');\n    }\n    if ((typeof x === 'object' && x !== null) || typeof x === 'function') {\n        let called;\n        try {\n            let then = x.then;\n            if (typeof then === 'function') {\n                then.call(x, (y) => {\n                    if (called) return;\n                    called = true;\n                    resolvePromise(y, promise2, resolve, reject)\n                }, r => {\n                    if (called) return;\n                    called = true;\n                    reject(r)\n                })\n            } else {\n                resolve(x);\n            }\n        } catch (err) {\n            if (called) return;\n            called = true;\n            reject(err)\n        }\n    } else {\n        resolve(x)\n    }\n}\nclass Promise {\n    constructor(executor) {\n        this.status = STATUS.PENDING;\n        this.val = undefined;\n        this.reason = undefined;\n        this.onResolveCallbacks = [];\n        this.onRejectCallbacks = [];\n        const resolve = val => {\n            if (val instanceof Promise) {\n                return val.then(resolve, reject)\n            }\n            if (this.status === STATUS.PENDING) {\n                this.status = STATUS.FULFILLED;\n                this.val = val;\n                this.onResolveCallbacks.forEach(fn => fn());\n            }\n        }\n        const reject = reason => {\n            if (this.status === STATUS.PENDING) {\n                this.status = STATUS.REJECTED;\n                this.reason = reason;\n                this.onRejectCallbacks.forEach(fn => fn());\n            }\n        }\n        try {\n            executor(resolve, reject)\n        } catch (err) {\n            reject(err)\n        }\n    }\n    then(onFulfilled, onRejected) {\n        onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : x => x;\n        onRejected = typeof onRejected === 'function' ? onRejected : err => { throw err };\n        let promise2 = new Promise((resolve, reject) => {\n            if (this.status === STATUS.FULFILLED) {\n                setTimeout(() => {\n                    try {\n                        let x = onFulfilled(this.val);\n                        resolvePromise(x, promise2, resolve, reject)\n                    } catch (err) {\n                        reject(err)\n                    }\n                }, 0);\n            }\n            if (this.status === STATUS.REJECTED) {\n                setTimeout(() => {\n                    try {\n                        let x = onRejected(this.reason);\n                        resolvePromise(x, promise2, resolve, reject)\n                    } catch (err) {\n                        reject(err)\n                    }\n                }, 0);\n            }\n            if (this.status === STATUS.PENDING) {\n                this.onResolveCallbacks.push(() => {\n                    setTimeout(() => {\n                        try {\n                            let x = onFulfilled(this.val);\n                            resolvePromise(x, promise2, resolve, reject)\n                        } catch (err) {\n                            reject(err)\n                        }\n                    }, 0);\n                })\n                this.onRejectCallbacks.push(() => {\n                    setTimeout(() => {\n                        try {\n                            let x = onRejected(this.reason);\n                            resolvePromise(x, promise2, resolve, reject)\n                        } catch (err) {\n                            reject(err)\n                        }\n                    }, 0);\n                })\n            }\n        })\n        return promise2;\n    }\n    catch(err) {\n        return this.then(null, err)\n    }\n\n    finally(callback) {\n        return this.then(data => {\n            return Promise.resolve(callback()).then(() => data)\n        }, err => {\n            return Promise.resolve(callback()).then(() => { throw err })\n        })\n    }\n\n    static resolve(val) {\n        return new Promise((resolve, reject) => {\n            resolve(val)\n        })\n    }\n    static reject(reason) {\n        return new Promise((resolve, reject) => {\n            reject(reason)\n        })\n    }\n    static all(promises) {\n        return new Promise((resolve, reject) => {\n            let result = [];\n            let times = 0;\n            function processData(index, val) {\n                result[index] = val;\n                if (++times === promises.length) {\n                    resolve(result);\n                }\n            }\n            for (let i = 0; i < promises.length; i++) {\n                let p = promises[i];\n                if (p && typeof p.then == 'function') {\n                    p.then((data) => {\n                        processData(i, data);// \u666e\u901a\u503c\n                    }, reject)\n                } else {\n                    processData(i, p);\n                }\n            }\n        })\n    }\n    static race(promises) {\n        return new Promise((resolve, reject) => {\n            for (let i = 0; i < promises.length; i++) {\n                let currentVal = promises[i];\n                if (currentVal && typeof currentVal.then === 'function') {\n                    currentVal.then(resolve, reject)\n                    //then(data => resolve(data)) ===> then(resolve)\n                } else {\n                    resolve(currentVal)\n                }\n            }\n        })\n    }\n    static allSettledl(promises) {\n        return Promise.all(promises.map(p => {\n            Promise.resolve(p).then(res => {\n                return { status: 'fulfilled', value: res }\n            }, err => {\n                return { status: 'rejected', reason: err }\n            })\n        }));\n    }\n}\nPromise.defer = Promise.deferred = function () {\n    let dfd = {}\n    dfd.promise = new Promise((resolve, reject) => {\n        dfd.resolve = resolve;\n        dfd.reject = reject;\n    })\n    return dfd;\n}\nmodule.exports = Promise\n")),(0,o.kt)("h4",{id:"promises-aplus-tests"},(0,o.kt)("inlineCode",{parentName:"h4"},"promises-aplus-tests")),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u4f7f\u7528\u7b2c\u4e09\u65b9\u5305\u6d4b\u8bd5\u81ea\u5df1\u5b9e\u73b0\u7684Promise\u662f\u5426\u7b26\u5408\u89c4\u8303")),(0,o.kt)("h5",{id:"1\u5b89\u88c5"},"1.\u5b89\u88c5"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sell"},"npm install promises-aplus-tests\n")),(0,o.kt)("h5",{id:"2\u6d4b\u8bd5"},"2.\u6d4b\u8bd5"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"promises-aplus-tests + \u6587\u4ef6\u540d\n\u4f8b\u5982\npromises-aplus-tests promise.js\n")),(0,o.kt)("h4",{id:"\u7ec3\u4e60\u9898"},"\u7ec3\u4e60\u9898"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-JS"},"Promise.resolve(1)\n.then(x=>x+1) // 2\n.then(x=>{throw new Error('my error')})\n.catch(()=>1) // 1  \u8fd4\u56de\u7684\u503c\u666e\u901a\u503c \u4f1a\u4f5c\u4e3a\u4e0b\u4e00\u6b21then\u7684\u6210\u529f\u7ed3\u679c\n.then(x=>x+1) // 2\n.then(x=>console.log(x))\n.catch(console.err)\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-JS"},"// \u5bf9Promise\u7406\u89e3\u6b63\u786e\u7684\u662f\n// 1.promise\u53ef\u4ee5\u8ba9\u5f02\u6b65\u4ee3\u7801\u53d8\u6210\u540c\u6b65\u4ee3\u7801   \u9519\u8bef\u7b54\u6848  generator / async + await\n// 2.promise\u89e3\u51b3\u4e86\u56de\u8c03\u5730\u72f1\u95ee\u9898\n// 3.promise\u65b9\u4fbf\u5904\u7406\u591a\u4e2a\u5f02\u6b65\u5e76\u53d1\u8bf7\u6c42\n// 4.promise\u9519\u8bef\u5904\u7406\u975e\u5e38\u4f18\u96c5\u548c\u65b9\u4fbf\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-JS"},"console.log(1);\nasync function async () {\n    console.log(2);\n    await console.log(3)\n    console.log(4)\n}\nsetTimeout(() => {\n    console.log(5);\n}, 0);\nconst promise = new Promise((resolve, reject) => {\n    console.log(6);\n    resolve(7)\n})\npromise.then(res => {\n    console.log(res)\n})\nasync(); \nconsole.log(8);\n//1 6 2 3 8 7 4 5\n")))}u.isMDXComponent=!0}}]);