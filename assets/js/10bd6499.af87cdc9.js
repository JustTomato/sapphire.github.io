"use strict";(self.webpackChunksapphire=self.webpackChunksapphire||[]).push([[363],{3905:(e,n,r)=>{r.d(n,{Zo:()=>i,kt:()=>v});var t=r(7294);function a(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function l(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,t)}return r}function o(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?l(Object(r),!0).forEach((function(n){a(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function s(e,n){if(null==e)return{};var r,t,a=function(e,n){if(null==e)return{};var r,t,a={},l=Object.keys(e);for(t=0;t<l.length;t++)r=l[t],n.indexOf(r)>=0||(a[r]=e[r]);return a}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(t=0;t<l.length;t++)r=l[t],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var u=t.createContext({}),p=function(e){var n=t.useContext(u),r=n;return e&&(r="function"==typeof e?e(n):o(o({},n),e)),r},i=function(e){var n=p(e.components);return t.createElement(u.Provider,{value:n},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},m=t.forwardRef((function(e,n){var r=e.components,a=e.mdxType,l=e.originalType,u=e.parentName,i=s(e,["components","mdxType","originalType","parentName"]),c=p(r),m=a,v=c["".concat(u,".").concat(m)]||c[m]||d[m]||l;return r?t.createElement(v,o(o({ref:n},i),{},{components:r})):t.createElement(v,o({ref:n},i))}));function v(e,n){var r=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var l=r.length,o=new Array(l);o[0]=m;var s={};for(var u in n)hasOwnProperty.call(n,u)&&(s[u]=n[u]);s.originalType=e,s[c]="string"==typeof e?e:a,o[1]=s;for(var p=2;p<l;p++)o[p]=r[p];return t.createElement.apply(null,o)}return t.createElement.apply(null,r)}m.displayName="MDXCreateElement"},4278:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>u,contentTitle:()=>o,default:()=>d,frontMatter:()=>l,metadata:()=>s,toc:()=>p});var t=r(7462),a=(r(7294),r(3905));const l={},o="\u624b\u5199Vue\u670d\u52a1\u7aef\u6e32\u67d3",s={unversionedId:"vue/SSR",id:"vue/SSR",title:"\u624b\u5199Vue\u670d\u52a1\u7aef\u6e32\u67d3",description:"\u6982\u5ff5\uff1a\u653e\u5728\u6d4f\u89c8\u5668\u8fdb\u884c\u5c31\u662f\u6d4f\u89c8\u5668\u6e32\u67d3,\u653e\u5728\u670d\u52a1\u5668\u8fdb\u884c\u5c31\u662f\u670d\u52a1\u5668\u6e32\u67d3\u3002",source:"@site/docs/vue/SSR.md",sourceDirName:"vue",slug:"/vue/SSR",permalink:"/sapphire.github.io/docs/vue/SSR",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Vuex",permalink:"/sapphire.github.io/docs/vue/Vuex"},next:{title:"WebComponent",permalink:"/sapphire.github.io/docs/vue/WebComponent"}},u={},p=[{value:"\u4e00.\u5f00\u59cbVue-SSR\u4e4b\u65c5",id:"\u4e00\u5f00\u59cbvue-ssr\u4e4b\u65c5",level:2},{value:"\u4e8c.\u91c7\u7528\u6a21\u677f\u6e32\u67d3",id:"\u4e8c\u91c7\u7528\u6a21\u677f\u6e32\u67d3",level:2},{value:"\u4e09.ssr\u76ee\u5f55\u521b\u5efa",id:"\u4e09ssr\u76ee\u5f55\u521b\u5efa",level:2},{value:"\u56db.\u901a\u8fc7webpack\u5b9e\u73b0\u7f16\u8bd1vue\u9879\u76ee",id:"\u56db\u901a\u8fc7webpack\u5b9e\u73b0\u7f16\u8bd1vue\u9879\u76ee",level:2},{value:"app.js",id:"appjs",level:3},{value:"client-entry.js",id:"client-entryjs",level:3},{value:"server-entry.js",id:"server-entryjs",level:3},{value:"\u4e94.\u914d\u7f6e\u5ba2\u6237\u7aef\u6253\u5305\u548c\u670d\u52a1\u7aef\u6253\u5305",id:"\u4e94\u914d\u7f6e\u5ba2\u6237\u7aef\u6253\u5305\u548c\u670d\u52a1\u7aef\u6253\u5305",level:2},{value:"\u516d.\u914d\u7f6e\u8fd0\u884c\u811a\u672c",id:"\u516d\u914d\u7f6e\u8fd0\u884c\u811a\u672c",level:2},{value:"\u4e03.\u670d\u52a1\u7aef\u914d\u7f6e",id:"\u4e03\u670d\u52a1\u7aef\u914d\u7f6e",level:2},{value:"\u4e03.\u901a\u8fc7json\u914d\u7f6e<code>createBundleRenderer</code>\u65b9\u6cd5",id:"\u4e03\u901a\u8fc7json\u914d\u7f6ecreatebundlerenderer\u65b9\u6cd5",level:2},{value:"\u516b.\u96c6\u6210<code>VueRouter</code>",id:"\u516b\u96c6\u6210vuerouter",level:2},{value:"\u914d\u7f6e\u5165\u53e3\u6587\u4ef6",id:"\u914d\u7f6e\u5165\u53e3\u6587\u4ef6",level:3},{value:"\u914d\u7f6e\u7ec4\u4ef6\u4fe1\u606f",id:"\u914d\u7f6e\u7ec4\u4ef6\u4fe1\u606f",level:3},{value:"\u9632\u6b62\u5237\u65b0\u9875\u9762\u4e0d\u5b58\u5728",id:"\u9632\u6b62\u5237\u65b0\u9875\u9762\u4e0d\u5b58\u5728",level:3},{value:"\u4fdd\u8bc1\u5f02\u6b65\u8def\u7531\u52a0\u8f7d\u5b8c\u6210",id:"\u4fdd\u8bc1\u5f02\u6b65\u8def\u7531\u52a0\u8f7d\u5b8c\u6210",level:3},{value:"\u5341.\u96c6\u6210vuex\u914d\u7f6e",id:"\u5341\u96c6\u6210vuex\u914d\u7f6e",level:2},{value:"\u5728\u540e\u7aef\u66f4\u65b0vuex",id:"\u5728\u540e\u7aef\u66f4\u65b0vuex",level:3},{value:"\u5728\u6d4f\u89c8\u5668\u8fd0\u884c\u65f6\u66ff\u6362store",id:"\u5728\u6d4f\u89c8\u5668\u8fd0\u884c\u65f6\u66ff\u6362store",level:3},{value:"\u9700\u8981\u6267\u884c\u7684\u94a9\u5b50\u51fd\u6570",id:"\u9700\u8981\u6267\u884c\u7684\u94a9\u5b50\u51fd\u6570",level:3}],i={toc:p},c="wrapper";function d(e){let{components:n,...l}=e;return(0,a.kt)(c,(0,t.Z)({},i,l,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"\u624b\u5199vue\u670d\u52a1\u7aef\u6e32\u67d3"},"\u624b\u5199Vue\u670d\u52a1\u7aef\u6e32\u67d3"),(0,a.kt)("p",null,"\u6982\u5ff5\uff1a\u653e\u5728\u6d4f\u89c8\u5668\u8fdb\u884c\u5c31\u662f\u6d4f\u89c8\u5668\u6e32\u67d3,\u653e\u5728\u670d\u52a1\u5668\u8fdb\u884c\u5c31\u662f\u670d\u52a1\u5668\u6e32\u67d3\u3002"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u5ba2\u6237\u7aef\u6e32\u67d3\u4e0d\u5229\u4e8e SEO \u641c\u7d22\u5f15\u64ce\u4f18\u5316"),(0,a.kt)("li",{parentName:"ul"},"\u670d\u52a1\u7aef\u6e32\u67d3\u662f\u53ef\u4ee5\u88ab\u722c\u866b\u6293\u53d6\u5230\u7684\uff0c\u5ba2\u6237\u7aef\u5f02\u6b65\u6e32\u67d3\u662f\u5f88\u96be\u88ab\u722c\u866b\u6293\u53d6\u5230\u7684"),(0,a.kt)("li",{parentName:"ul"},"SSR\u76f4\u63a5\u5c06HTML\u5b57\u7b26\u4e32\u4f20\u9012\u7ed9\u6d4f\u89c8\u5668\u3002\u5927\u5927\u52a0\u5feb\u4e86\u9996\u5c4f\u52a0\u8f7d\u65f6\u95f4\u3002"),(0,a.kt)("li",{parentName:"ul"},"SSR\u5360\u7528\u66f4\u591a\u7684CPU\u548c\u5185\u5b58\u8d44\u6e90"),(0,a.kt)("li",{parentName:"ul"},"\u4e00\u4e9b\u5e38\u7528\u7684\u6d4f\u89c8\u5668API\u53ef\u80fd\u65e0\u6cd5\u6b63\u5e38\u4f7f\u7528"),(0,a.kt)("li",{parentName:"ul"},"\u5728Vue\u4e2d\u53ea\u652f\u6301",(0,a.kt)("inlineCode",{parentName:"li"},"beforeCreate"),"\u548c",(0,a.kt)("inlineCode",{parentName:"li"},"created"),"\u4e24\u4e2a\u751f\u547d\u5468\u671f")),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"img",src:r(1468).Z,width:"800",height:"367"})),(0,a.kt)("h2",{id:"\u4e00\u5f00\u59cbvue-ssr\u4e4b\u65c5"},"\u4e00.\u5f00\u59cbVue-SSR\u4e4b\u65c5"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"yarn add vue-server-renderer vue\nyarn add koa koa-router\n")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"createRenderer"),",\u521b\u5efa\u4e00\u4e2a\u6e32\u67d3\u51fd\u6570",(0,a.kt)("inlineCode",{parentName:"p"}," renderToString"),", \u6e32\u67d3\u51fa\u4e00\u4e2a\u5b57\u7b26\u4e32"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},'const Vue = require(\'vue\');\nconst render = require(\'vue-server-renderer\');\nconst Koa = require(\'koa\');\nconst Router = require(\'koa-router\');\nconst app = new Koa();\nconst router = new Router();\nconst vm = new Vue({\n    data(){\n        return {msg:"hello world"}\n    },\n    template:`<div>{{msg}}</div>`\n});\nrouter.get(\'/\',async (ctx)=>{\n    let r = await render.createRenderer().renderToString(vm);\n    ctx.body = `\n    <!DOCTYPE html>\n    <html lang="en">\n    <head>\n        <meta charset="UTF-8">\n        <meta name="viewport" content="width=device-width, initial-scale=1.0">\n        <meta http-equiv="X-UA-Compatible" content="ie=edge">\n        <title>Document</title>\n    </head>\n    <body>\n        ${r}\n    </body>\n    </html>\n    `\n});\napp.use(router.routes());\napp.listen(4000);\n')),(0,a.kt)("h2",{id:"\u4e8c\u91c7\u7528\u6a21\u677f\u6e32\u67d3"},"\u4e8c.\u91c7\u7528\u6a21\u677f\u6e32\u67d3"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-html"},'<!DOCTYPE html>\n<html lang="en">\n  <head><title>Hello</title></head>\n  <body>\n    \x3c!--vue-ssr-outlet--\x3e\n  </body>\n</html>\n')),(0,a.kt)("p",null,"\u4f20\u5165template \u66ff\u6362\u6389\u6ce8\u91ca\u6807\u7b7e"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"const Vue = require('vue');\nconst render = require('vue-server-renderer');\nconst Koa = require('koa');\nconst Router = require('koa-router');\nconst app = new Koa();\nconst router = new Router();\nconst vm = new Vue({\n    data(){\n        return {msg:\"hello world\"}\n    },\n    template:`<div>{{msg}}</div>`\n});\nconst template = require('fs').readFileSync('./index.html','utf8');\nrouter.get('/',async (ctx)=>{\n    let r = await render.createRenderer({\n        template\n    }).renderToString(vm);\n    ctx.body = r;\n});\napp.use(router.routes());\napp.listen(4000);\n")),(0,a.kt)("h2",{id:"\u4e09ssr\u76ee\u5f55\u521b\u5efa"},"\u4e09.ssr\u76ee\u5f55\u521b\u5efa"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"\u251c\u2500\u2500 config\n\u2502   \u251c\u2500\u2500 webpack.base.js\n\u2502   \u251c\u2500\u2500 webpack.client.js\n\u2502   \u2514\u2500\u2500 webpack.server.js\n\u251c\u2500\u2500 dist\n\u2502   \u251c\u2500\u2500 client.bundle.js\n\u2502   \u251c\u2500\u2500 index.html\n\u2502   \u251c\u2500\u2500 index.ssr.html\n\u2502   \u251c\u2500\u2500 server.bundle.js\n\u2502   \u251c\u2500\u2500 vue-ssr-client-manifest.json\n\u2502   \u2514\u2500\u2500 vue-ssr-server-bundle.json\n\u251c\u2500\u2500 package.json\n\u251c\u2500\u2500 public\n\u2502   \u251c\u2500\u2500 index.html\n\u2502   \u2514\u2500\u2500 index.ssr.html\n\u251c\u2500\u2500 server.js\n\u251c\u2500\u2500 src\n\u2502   \u251c\u2500\u2500 App.vue\n\u2502   \u251c\u2500\u2500 components\n\u2502   \u2502   \u251c\u2500\u2500 Bar.vue\n\u2502   \u2502   \u2514\u2500\u2500 Foo.vue\n\u2502   \u251c\u2500\u2500 entry-client.js\n\u2502   \u251c\u2500\u2500 entry-server.js\n\u2502   \u251c\u2500\u2500 app.js\n\u2502   \u251c\u2500\u2500 router.js\n\u2502   \u2514\u2500\u2500 store.js\n\u251c\u2500\u2500 webpack.config.js\n")),(0,a.kt)("h2",{id:"\u56db\u901a\u8fc7webpack\u5b9e\u73b0\u7f16\u8bd1vue\u9879\u76ee"},"\u56db.\u901a\u8fc7webpack\u5b9e\u73b0\u7f16\u8bd1vue\u9879\u76ee"),(0,a.kt)("p",null,"\u5b89\u88c5\u63d2\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"yarn add webpack webpack-cli webpack-dev-server vue-loader vue-style-loader css-loader html-webpack-plugin @babel/core @babel/preset-env babel-loader vue-template-compiler webpack-merge\n\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"const path = require('path');\nconst HtmlWebpackPlugin = require('html-webpack-plugin');\nconst VueLoaderPlugin = require('vue-loader/lib/plugin')\nconst resolve = (dir)=>{\n    return path.resolve(__dirname,dir)\n}\nmodule.exports = {\n    entry: resolve('./src/client-entry.js'),\n    output:{\n        filename:'[name].bundle.js',\n        path:resolve('dist')\n    },\n    module:{\n        rules:[\n            {\n                test:/\\.css$/,\n                use:['vue-style-loader','css-loader']\n            },\n            {\n                test:/\\.js$/,\n                use:{\n                    loader:'babel-loader',\n                    options:{\n                        presets:['@babel/preset-env']\n                    }\n                },\n                exclude:/node_modules/\n            },\n            {\n                test:/.vue$/,\n                use:'vue-loader'\n            }\n        ]\n    },\n    plugins:[\n        new VueLoaderPlugin(),\n        new HtmlWebpackPlugin({\n            template:'./index.html'\n        })\n    ]\n}\n")),(0,a.kt)("h3",{id:"appjs"},"app.js"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},'import Vue from "vue";\nimport App from "./App.vue";\nexport default () => { // \u4e3a\u4e86\u4fdd\u8bc1\u5b9e\u4f8b\u7684\u552f\u4e00\u6027\u6240\u4ee5\u5bfc\u51fa\u4e00\u4e2a\u521b\u5efa\u5b9e\u4f8b\u7684\u51fd\u6570\n  const app = new Vue({\n    render: h => h(App)\n  });\n  return { app };\n};\n')),(0,a.kt)("h3",{id:"client-entryjs"},"client-entry.js"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},'import createApp from "./app";\nconst { app } = createApp();\napp.$mount("#app"); // \u5ba2\u6237\u7aef\u6e32\u67d3\u624b\u52a8\u6302\u8f7d\u5230dom\u5143\u7d20\u4e0a\n')),(0,a.kt)("h3",{id:"server-entryjs"},"server-entry.js"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},'import createApp from "./app";\nexport default () => {\n  const { app } = createApp();\n  return app; // \u670d\u52a1\u7aef\u6e32\u67d3\u53ea\u9700\u5c06\u6e32\u67d3\u7684\u5b9e\u4f8b\u5bfc\u51fa\u5373\u53ef\n};\n')),(0,a.kt)("h2",{id:"\u4e94\u914d\u7f6e\u5ba2\u6237\u7aef\u6253\u5305\u548c\u670d\u52a1\u7aef\u6253\u5305"},"\u4e94.\u914d\u7f6e\u5ba2\u6237\u7aef\u6253\u5305\u548c\u670d\u52a1\u7aef\u6253\u5305"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"webpack.base.js")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"let path = require('path');\nlet VueLoaderPlugin = require('vue-loader/lib/plugin')\nmodule.exports = {\n    output:{\n        filename:'[name].bundle.js',\n        path:path.resolve(__dirname,'../dist')\n    },\n    module:{\n        rules:[\n            {test:/\\.css/,use:['vue-style-loader','css-loader']},\n            {\n                test:/\\.js/,\n                use:{\n                    loader:'babel-loader',\n                    options:{\n                        presets:['@babel/preset-env']\n                     },\n                },\n                exclude:/node_modules/,\n            },\n            {test:/\\.vue/,use:'vue-loader'}\n        ]\n    },\n    plugins:[\n        new VueLoaderPlugin()\n    ]\n}\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"webpack.client.js")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},'const merge = require("webpack-merge");\nconst path = require("path");\nconst HtmlWebpackPlugin = require("html-webpack-plugin");\nconst base = require("./webpack.base");\nconst resolve = filepath => {\n  return path.resolve(__dirname, filepath);\n};\nmodule.exports = merge(base, {\n  entry: {\n    client: resolve("../src/client-entry.js")\n  },\n  plugins: [\n    new HtmlWebpackPlugin({\n      template: resolve("../template/index.client.html")\n    })\n  ]\n});\n')),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"webpack.server.js")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},'const merge = require("webpack-merge");\nconst path = require("path");\nconst HtmlWebpackPlugin = require("html-webpack-plugin");\nconst base = require("./webpack.base");\nconst resolve = filepath => {\n  return path.resolve(__dirname, filepath);\n};\nmodule.exports = merge(base, {\n  entry: {\n    server: resolve("../src/server-entry.js")\n  },\n  target: "node",\n  output: {\n    libraryTarget: "commonjs2" // \u5bfc\u51fa\u4f9b\u670d\u52a1\u7aef\u6e32\u67d3\u6765\u4f7f\u7528 module.exports = () => {}   \n  },\n  plugins: [\n    new HtmlWebpackPlugin({\n      filename: "index.ssr.html",\n      template: resolve("../template/index.ssr.html"),\n      excludeChunks: ["server"]\n    })\n  ]\n});\n')),(0,a.kt)("h2",{id:"\u516d\u914d\u7f6e\u8fd0\u884c\u811a\u672c"},"\u516d.\u914d\u7f6e\u8fd0\u884c\u811a\u672c"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'"scripts": {\n    "client:dev": "webpack-dev-server --config ./build/webpack.client.js", // \u5ba2\u6237\u7aef\u5f00\u53d1\u73af\u5883\n    "client:build": "webpack --config ./build/webpack.client.js", // \u5ba2\u6237\u7aef\u6253\u5305\u73af\u5883\n    "server:build": "webpack --config ./build/webpack.server.js" // \u670d\u52a1\u7aef\u6253\u5305\u73af\u5883\n },\n')),(0,a.kt)("h2",{id:"\u4e03\u670d\u52a1\u7aef\u914d\u7f6e"},"\u4e03.\u670d\u52a1\u7aef\u914d\u7f6e"),(0,a.kt)("p",null,"\u5728",(0,a.kt)("inlineCode",{parentName:"p"},"App.vue"),'\u4e0a\u589e\u52a0id="app"\u53ef\u4ee5\u4fdd\u8bc1\u5143\u7d20\u88ab\u6b63\u5e38\u6fc0\u6d3b'),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},'const Koa = require("koa");\nconst Router = require("koa-router");\nconst static = require("koa-static");\nconst path = require("path");\nconst app = new Koa();\nconst router = new Router();\nconst VueServerRenderer = require("vue-server-renderer");\nconst fs = require("fs");\n// \u670d\u52a1\u7aef\u6253\u5305\u7684\u7ed3\u679c\nconst serverBundle = fs.readFileSync("./dist/server.bundle.js", "utf8");\nconst template = fs.readFileSync("./dist/index.ssr.html", "utf8");\nconst render = VueServerRenderer.createBundleRenderer(serverBundle, {\n  template\n});\nrouter.get("/", async ctx => {\n  ctx.body = await new Promise((resolve, reject) => {\n    render.renderToString((err, html) => {\n      // \u5fc5\u987b\u5199\u6210\u56de\u8c03\u51fd\u6570\u7684\u65b9\u5f0f\u5426\u5219\u6837\u5f0f\u4e0d\u751f\u6548\n      resolve(html);\n    });\n  });\n});\napp.use(router.routes());\napp.use(static(path.resolve(__dirname, "dist")));\napp.listen(3000);\n')),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u5728index.ssr.html\u4e2d\u9700\u8981\u624b\u52a8\u5f15\u5165\u5ba2\u6237\u7aef\u6253\u5305\u540e\u7684\u7ed3\u679c")),(0,a.kt)("h2",{id:"\u4e03\u901a\u8fc7json\u914d\u7f6ecreatebundlerenderer\u65b9\u6cd5"},"\u4e03.\u901a\u8fc7json\u914d\u7f6e",(0,a.kt)("inlineCode",{parentName:"h2"},"createBundleRenderer"),"\u65b9\u6cd5"),(0,a.kt)("p",null,"\u5b9e\u73b0\u70ed\u66f4\u65b0,\u81ea\u52a8\u589e\u52a0preload\u548cprefetch,\u4ee5\u53ca\u53ef\u4ee5\u4f7f\u7528sourceMap"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},'const VueSSRClientPlugin = require(\'vue-server-renderer/client-plugin\'); // \u5728\u5ba2\u6237\u7aef\u6253\u5305\u65f6\u589e\u52a0\u63d2\u4ef6\nconst VueSSRServerPlugin = require(\'vue-server-renderer/server-plugin\'); // \u5728\u670d\u52a1\u7aef\u6253\u5305\u65f6\u589e\u52a0\u63d2\u4ef6\n\n\nconst Koa = require("koa");\nconst Router = require("koa-router");\nconst static = require("koa-static");\nconst path = require("path");\nconst app = new Koa();\nconst router = new Router();\nconst VueServerRenderer = require("vue-server-renderer");\nconst fs = require("fs");\n// \u670d\u52a1\u7aef\u6253\u5305\u7684\u7ed3\u679c\n// const serverBundle = fs.readFileSync("./dist/server.bundle.js", "utf8");\nconst template = fs.readFileSync("./dist/index.ssr.html", "utf8");\nconst serverBundle = require("./dist/vue-ssr-server-bundle.json");\nconst clientManifest = require("./dist/vue-ssr-client-manifest.json");\nconst render = VueServerRenderer.createBundleRenderer(serverBundle, {\n  template,\n  clientManifest // \u81ea\u52a8\u6ce8\u5165\u5ba2\u6237\u7aef\u6253\u5305\u540e\u7684\u6587\u4ef6\n});\n\nrouter.get("/", async ctx => {\n  ctx.body = await new Promise((resolve, reject) => {\n    render.renderToString((err, html) => {\n      // \u5fc5\u987b\u5199\u6210\u56de\u8c03\u51fd\u6570\u7684\u65b9\u5f0f\u5426\u5219\u6837\u5f0f\u4e0d\u751f\u6548\n      resolve(html);\n    });\n  });\n});\napp.use(router.routes());\napp.use(static(path.resolve(__dirname, "dist")));\napp.listen(3000);\n')),(0,a.kt)("h2",{id:"\u516b\u96c6\u6210vuerouter"},"\u516b.\u96c6\u6210",(0,a.kt)("inlineCode",{parentName:"h2"},"VueRouter")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"yarn add vue-router\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},'import Vue from "vue";\nimport VueRouter from "vue-router";\nimport Foo from "./components/Foo.vue";\nVue.use(VueRouter);\nexport default () => {\n  const router = new VueRouter({\n    mode: "history",\n    routes: [\n      { path: "/", component: Foo },\n      { path: "/bar", component: () => import("./components/Bar.vue") }\n    ]\n  });\n  return router;\n};\n')),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u5bfc\u51fa\u8def\u7531\u914d\u7f6e")),(0,a.kt)("h3",{id:"\u914d\u7f6e\u5165\u53e3\u6587\u4ef6"},"\u914d\u7f6e\u5165\u53e3\u6587\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},'import Vue from "vue";\nimport App from "./App.vue";\nimport createRouter from "./router";\nexport default () => {\n  const router = createRouter();\n  const app = new Vue({\n    router,\n    render: h => h(App)\n  });\n  return { app, router };\n};\n')),(0,a.kt)("h3",{id:"\u914d\u7f6e\u7ec4\u4ef6\u4fe1\u606f"},"\u914d\u7f6e\u7ec4\u4ef6\u4fe1\u606f"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},'<template>\n    <div id="app">\n        <router-link to="/"> foo</router-link>\n        <router-link to="/bar"> bar</router-link>\n        <router-view></router-view>\n    </div>\n</template>\n')),(0,a.kt)("h3",{id:"\u9632\u6b62\u5237\u65b0\u9875\u9762\u4e0d\u5b58\u5728"},"\u9632\u6b62\u5237\u65b0\u9875\u9762\u4e0d\u5b58\u5728"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},'router.get("*", async ctx => {\n  ctx.body = await new Promise((resolve, reject) => {\n    render.renderToString({ url: ctx.url }, (err, html) => {\n      // \u5fc5\u987b\u5199\u6210\u56de\u8c03\u51fd\u6570\u7684\u65b9\u5f0f\u5426\u5219\u6837\u5f0f\u4e0d\u751f\u6548\n      resolve(html);\n    });\n  });\n});\n')),(0,a.kt)("h3",{id:"\u4fdd\u8bc1\u5f02\u6b65\u8def\u7531\u52a0\u8f7d\u5b8c\u6210"},"\u4fdd\u8bc1\u5f02\u6b65\u8def\u7531\u52a0\u8f7d\u5b8c\u6210"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},'export default ({ url }) => {\n  return new Promise((resolve, reject) => {\n    const { app, router } = createApp();\n    router.push(url);\n    router.onReady(() => {\n      const matchComponents = router.getMatchedComponents();\n      if (!matchComponents.length) {\n        return reject({ code: 404 });\n      }\n      resolve(app);\n    }, reject);\n  });\n};\n\n// \u670d\u52a1\u5668\u53ef\u4ee5\u76d1\u63a7\u5230\u9519\u8bef\u4fe1\u606f\uff0c\u8fd4\u56de404\nrender.renderToString({ url: ctx.url }, (err, html) => {\n      // \u5fc5\u987b\u5199\u6210\u56de\u8c03\u51fd\u6570\u7684\u65b9\u5f0f\u5426\u5219\u6837\u5f0f\u4e0d\u751f\u6548\n    if (err && err.code == 404) {\n    resolve("404 Not Found");\n    }\n    resolve(html);\n});\n')),(0,a.kt)("h2",{id:"\u5341\u96c6\u6210vuex\u914d\u7f6e"},"\u5341.\u96c6\u6210vuex\u914d\u7f6e"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"yarn add vuex\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"import Vue from 'vue';\nimport Vuex from 'vuex';\nVue.use(Vuex);\n\nexport default ()=>{\n    let store = new Vuex.Store({\n        state:{\n            username:'song'\n        },\n        mutations:{\n            changeName(state){\n                state.username = 'hello';\n            }\n        },\n        actions:{\n            changeName({commit}){\n                return new Promise((resolve,reject)=>{\n                    setTimeout(() => {\n                        commit('changeName');\n                        resolve();\n                    }, 1000);\n                })\n            }\n        }\n    });\n    return store\n}\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"// \u5f15\u7528vuex\nimport createRouter from './router';\nimport createStore from './store'\nexport default ()=>{\n    let router = createRouter();\n    let store = createStore();\n    let app = new Vue({\n        router,\n        store,\n        render:(h)=>h(App)\n    })\n    return {app,router,store}\n}\n")),(0,a.kt)("h3",{id:"\u5728\u540e\u7aef\u66f4\u65b0vuex"},"\u5728\u540e\u7aef\u66f4\u65b0vuex"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"import createApp from './main';\nexport default (context)=>{\n    return new Promise((resolve)=>{\n        let {app,router,store} = createApp();\n        router.push(context.url); // \u9ed8\u8ba4\u8bbf\u95ee\u5230/a\u5c31\u8df3\u8f6c\u5230/a\n        router.onReady(()=>{\n            let matchComponents = router.getMatchedComponents(); // \u83b7\u53d6\u8def\u7531\u5339\u914d\u5230\u7684\u7ec4\u4ef6\n            \n            Promise.all(matchComponents.map(component=>{\n                if(component.asyncData){\n                    return component.asyncData(store);\n                }\n            })).then(()=>{\n                context.state = store.state; // \u5c06store\u6302\u8f7d\u5728window.__INITIAL_STATE__\n                resolve(app);\n\n            });\n        })\n    })\n}\n")),(0,a.kt)("h3",{id:"\u5728\u6d4f\u89c8\u5668\u8fd0\u884c\u65f6\u66ff\u6362store"},"\u5728\u6d4f\u89c8\u5668\u8fd0\u884c\u65f6\u66ff\u6362store"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"// \u5728\u6d4f\u89c8\u5668\u8fd0\u884c\u4ee3\u7801\nif(typeof window !== 'undefined' && window.__INITIAL_STATE__){\n    store.replaceState(window.__INITIAL_STATE__);\n}\n")),(0,a.kt)("h3",{id:"\u9700\u8981\u6267\u884c\u7684\u94a9\u5b50\u51fd\u6570"},"\u9700\u8981\u6267\u884c\u7684\u94a9\u5b50\u51fd\u6570"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},'export default {\n mounted() {\n  return this.$store.dispatch("changeName");\n },\n asyncData(store) {\n  return store.dispatch("changeName");\n }\n};\n')))}d.isMDXComponent=!0},1468:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/ssr.29164cfb-95490a57c831f4a94c0ac13dda421c49.png"}}]);